# StockGuru 阿里云部署指南

**版本**: v1.0  
**更新时间**: 2025-10-15

---

## 📋 目录

1. [部署方案选择](#部署方案选择)
2. [方案1: ECS 云服务器部署](#方案1-ecs-云服务器部署)
3. [方案2: 函数计算 + OSS 部署](#方案2-函数计算--oss-部署)
4. [方案3: 容器服务 ACK 部署](#方案3-容器服务-ack-部署)
5. [域名和 SSL 配置](#域名和-ssl-配置)
6. [监控和运维](#监控和运维)

---

## 部署方案选择

### 方案对比

| 方案 | 成本 | 难度 | 适用场景 |
|------|------|------|----------|
| **ECS 云服务器** | ¥100-300/月 | ⭐⭐ | 完全控制，适合长期运行 |
| **函数计算 + OSS** | ¥10-50/月 | ⭐⭐⭐ | 按量付费，适合低流量 |
| **容器服务 ACK** | ¥200-500/月 | ⭐⭐⭐⭐ | 高可用，适合生产环境 |

**推荐**: 个人项目或小团队使用 **ECS 云服务器**，性价比最高。

---

## 方案1: ECS 云服务器部署

### 1.1 购买 ECS 实例

1. **登录阿里云控制台**
   - 访问 https://ecs.console.aliyun.com

2. **创建实例**
   - 地域: 选择离用户近的（如华东2-上海）
   - 实例规格: 
     - 入门: `ecs.t6-c1m1.large` (1核2G) - ¥60/月
     - 推荐: `ecs.t6-c1m2.large` (1核4G) - ¥100/月
   - 镜像: Ubuntu 22.04 64位
   - 存储: 40GB 高效云盘
   - 网络: 按使用流量计费（1-5Mbps）

3. **安全组配置**
   - 开放端口: 22 (SSH), 80 (HTTP), 443 (HTTPS), 8000 (API)

### 1.2 连接服务器

```bash
# 使用 SSH 连接
ssh root@your-server-ip

# 首次登录后，创建新用户（安全考虑）
adduser stockguru
usermod -aG sudo stockguru
su - stockguru
```

### 1.3 安装基础环境

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 安装 Python 3.10+
sudo apt install -y python3 python3-pip python3-venv

# 安装 Nginx
sudo apt install -y nginx

# 安装 Git
sudo apt install -y git

# 验证安装
node --version
python3 --version
nginx -v
```

### 1.4 克隆项目

```bash
# 创建项目目录
mkdir -p ~/apps
cd ~/apps

# 克隆项目
git clone https://github.com/wenbit/StockGuru.git
cd StockGuru
```

### 1.5 部署后端

```bash
# 进入后端目录
cd ~/apps/StockGuru/stockguru-web/backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
nano .env
```

编辑 `.env` 文件：
```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key
FRONTEND_URL=https://your-domain.com
API_HOST=0.0.0.0
API_PORT=8000
LOG_LEVEL=INFO
```

```bash
# 测试运行
uvicorn app.main:app --host 0.0.0.0 --port 8000

# 访问测试
curl http://localhost:8000/health
```

### 1.6 使用 Systemd 管理后端服务

创建服务文件：

```bash
sudo nano /etc/systemd/system/stockguru-backend.service
```

内容：
```ini
[Unit]
Description=StockGuru Backend API
After=network.target

[Service]
Type=simple
User=stockguru
WorkingDirectory=/home/stockguru/apps/StockGuru/stockguru-web/backend
Environment="PATH=/home/stockguru/apps/StockGuru/stockguru-web/backend/venv/bin"
ExecStart=/home/stockguru/apps/StockGuru/stockguru-web/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
# 重载配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start stockguru-backend

# 设置开机自启
sudo systemctl enable stockguru-backend

# 查看状态
sudo systemctl status stockguru-backend

# 查看日志
sudo journalctl -u stockguru-backend -f
```

### 1.7 部署前端

```bash
# 进入前端目录
cd ~/apps/StockGuru/frontend

# 安装依赖
npm install

# 配置环境变量
nano .env.local
```

内容：
```env
NEXT_PUBLIC_API_URL=https://api.your-domain.com
```

```bash
# 构建生产版本
npm run build

# 安装 PM2
sudo npm install -g pm2

# 启动前端
pm2 start npm --name "stockguru-frontend" -- start

# 保存 PM2 配置
pm2 save

# 设置开机自启
pm2 startup
# 复制输出的命令并执行

# 查看状态
pm2 status
pm2 logs stockguru-frontend
```

### 1.8 配置 Nginx 反向代理

```bash
# 创建配置文件
sudo nano /etc/nginx/sites-available/stockguru
```

内容：
```nginx
# 前端服务
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}

# 后端 API
server {
    listen 80;
    server_name api.your-domain.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # CORS 配置
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
    }
}
```

启用配置：
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/stockguru /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx

# 设置开机自启
sudo systemctl enable nginx
```

### 1.9 配置防火墙

```bash
# 安装 UFW
sudo apt install -y ufw

# 允许必要端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS

# 启用防火墙
sudo ufw enable

# 查看状态
sudo ufw status
```

---

## 方案2: 函数计算 + OSS 部署

### 2.1 部署前端到 OSS

1. **创建 OSS 存储桶**
   - 访问 https://oss.console.aliyun.com
   - 创建 Bucket: `stockguru-web`
   - 区域: 华东2（上海）
   - 读写权限: 公共读

2. **构建前端**
   ```bash
   cd frontend
   npm run build
   npm run export  # 导出静态文件到 out 目录
   ```

3. **上传到 OSS**
   ```bash
   # 安装 ossutil
   wget http://gosspublic.alicdn.com/ossutil/1.7.15/ossutil64
   chmod 755 ossutil64
   
   # 配置
   ./ossutil64 config
   # 输入 AccessKey ID, AccessKey Secret, Endpoint
   
   # 上传文件
   ./ossutil64 cp -r out/ oss://stockguru-web/ --update
   ```

4. **配置静态网站托管**
   - 在 OSS 控制台，选择 Bucket
   - 基础设置 -> 静态页面
   - 默认首页: index.html
   - 默认 404 页: 404.html

### 2.2 部署后端到函数计算

1. **创建函数**
   - 访问 https://fc.console.aliyun.com
   - 创建服务: `stockguru-backend`
   - 创建函数: HTTP 函数
   - 运行环境: Python 3.10

2. **上传代码**
   ```bash
   cd stockguru-web/backend
   
   # 打包代码
   zip -r function.zip app/ requirements.txt
   
   # 通过控制台上传 function.zip
   ```

3. **配置环境变量**
   - 在函数配置中添加环境变量
   - SUPABASE_URL
   - SUPABASE_KEY

4. **配置触发器**
   - 类型: HTTP 触发器
   - 路径: /
   - 方法: ANY

---

## 方案3: 容器服务 ACK 部署

### 3.1 创建 Kubernetes 集群

1. **访问容器服务控制台**
   - https://cs.console.aliyun.com

2. **创建托管版集群**
   - 集群名称: stockguru-cluster
   - 地域: 华东2（上海）
   - 节点规格: 2核4G
   - 节点数量: 2

### 3.2 准备 Docker 镜像

```bash
# 构建后端镜像
cd stockguru-web/backend
docker build -t stockguru-backend:latest .

# 构建前端镜像
cd ../../frontend
docker build -t stockguru-frontend:latest .

# 推送到阿里云容器镜像服务
# 1. 登录 https://cr.console.aliyun.com
# 2. 创建命名空间: stockguru
# 3. 创建镜像仓库

# 登录镜像仓库
docker login --username=your-username registry.cn-shanghai.aliyuncs.com

# 打标签
docker tag stockguru-backend:latest registry.cn-shanghai.aliyuncs.com/stockguru/backend:latest
docker tag stockguru-frontend:latest registry.cn-shanghai.aliyuncs.com/stockguru/frontend:latest

# 推送
docker push registry.cn-shanghai.aliyuncs.com/stockguru/backend:latest
docker push registry.cn-shanghai.aliyuncs.com/stockguru/frontend:latest
```

### 3.3 部署到 Kubernetes

创建 `k8s-deployment.yaml`:

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: stockguru

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: stockguru
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: registry.cn-shanghai.aliyuncs.com/stockguru/backend:latest
        ports:
        - containerPort: 8000
        env:
        - name: SUPABASE_URL
          value: "your-url"
        - name: SUPABASE_KEY
          value: "your-key"

---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: stockguru
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8000
  selector:
    app: backend

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: stockguru
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: registry.cn-shanghai.aliyuncs.com/stockguru/frontend:latest
        ports:
        - containerPort: 3000
        env:
        - name: NEXT_PUBLIC_API_URL
          value: "http://backend-service"

---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: stockguru
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 3000
  selector:
    app: frontend
```

部署：
```bash
# 配置 kubectl
# 在 ACK 控制台获取 kubeconfig

# 应用配置
kubectl apply -f k8s-deployment.yaml

# 查看状态
kubectl get pods -n stockguru
kubectl get services -n stockguru

# 查看日志
kubectl logs -f deployment/backend -n stockguru
kubectl logs -f deployment/frontend -n stockguru
```

---

## 域名和 SSL 配置

### 1. 域名解析

1. **购买域名**
   - 访问 https://wanwang.aliyun.com
   - 购买域名（如 stockguru.com）

2. **添加解析记录**
   - 访问 https://dns.console.aliyun.com
   - 添加 A 记录:
     - `@` -> 服务器IP（主域名）
     - `www` -> 服务器IP（www子域名）
     - `api` -> 服务器IP（API子域名）

### 2. 配置 SSL 证书

**方法1: 使用 Let's Encrypt（免费）**

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com -d api.your-domain.com

# 自动续期
sudo certbot renew --dry-run

# 设置定时任务
sudo crontab -e
# 添加: 0 3 * * * certbot renew --quiet
```

**方法2: 使用阿里云 SSL 证书**

1. 访问 https://yundun.console.aliyun.com/?p=cas
2. 购买免费证书（20个/年）
3. 申请证书并绑定域名
4. 下载证书（选择 Nginx 格式）
5. 上传到服务器并配置 Nginx

```bash
# 创建证书目录
sudo mkdir -p /etc/nginx/ssl

# 上传证书文件
sudo cp your-domain.com.pem /etc/nginx/ssl/
sudo cp your-domain.com.key /etc/nginx/ssl/

# 修改 Nginx 配置
sudo nano /etc/nginx/sites-available/stockguru
```

更新配置：
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    ssl_certificate /etc/nginx/ssl/your-domain.com.pem;
    ssl_certificate_key /etc/nginx/ssl/your-domain.com.key;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

```bash
# 重启 Nginx
sudo systemctl restart nginx
```

---

## 监控和运维

### 1. 日志管理

```bash
# 后端日志
sudo journalctl -u stockguru-backend -f

# 前端日志
pm2 logs stockguru-frontend

# Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 2. 性能监控

**使用阿里云云监控**

1. 访问 https://cloudmonitor.console.aliyun.com
2. 添加 ECS 实例监控
3. 配置告警规则:
   - CPU 使用率 > 80%
   - 内存使用率 > 80%
   - 磁盘使用率 > 80%

**使用 PM2 监控**

```bash
# 查看进程状态
pm2 status

# 实时监控
pm2 monit

# 查看详细信息
pm2 show stockguru-frontend
```

### 3. 自动备份

创建备份脚本 `~/backup.sh`:

```bash
#!/bin/bash

# 配置
BACKUP_DIR="/home/stockguru/backups"
DATE=$(date +%Y%m%d_%H%M%S)
PROJECT_DIR="/home/stockguru/apps/StockGuru"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份代码
cd $PROJECT_DIR
git pull origin main
tar -czf $BACKUP_DIR/stockguru_$DATE.tar.gz .

# 保留最近7天的备份
find $BACKUP_DIR -name "stockguru_*.tar.gz" -mtime +7 -delete

echo "Backup completed: stockguru_$DATE.tar.gz"
```

```bash
# 添加执行权限
chmod +x ~/backup.sh

# 设置定时任务（每天凌晨3点）
crontab -e
# 添加: 0 3 * * * /home/stockguru/backup.sh
```

### 4. 更新部署

```bash
# 创建更新脚本 ~/update.sh
#!/bin/bash

cd ~/apps/StockGuru

# 拉取最新代码
git pull origin main

# 更新后端
cd stockguru-web/backend
source venv/bin/activate
pip install -r requirements.txt
sudo systemctl restart stockguru-backend

# 更新前端
cd ../../frontend
npm install
npm run build
pm2 restart stockguru-frontend

echo "Update completed!"
```

```bash
# 添加执行权限
chmod +x ~/update.sh

# 执行更新
~/update.sh
```

---

## 成本估算

### ECS 方案（推荐）

| 项目 | 配置 | 费用 |
|------|------|------|
| ECS 实例 | 1核4G | ¥100/月 |
| 带宽 | 5Mbps | ¥30/月 |
| 云盘 | 40GB | ¥10/月 |
| 域名 | .com | ¥60/年 |
| SSL 证书 | 免费 | ¥0 |
| **总计** | | **¥140/月** |

### 函数计算方案

| 项目 | 配置 | 费用 |
|------|------|------|
| OSS 存储 | 10GB | ¥2/月 |
| OSS 流量 | 10GB/月 | ¥5/月 |
| 函数计算 | 100万次调用 | ¥10/月 |
| 域名 | .com | ¥60/年 |
| **总计** | | **¥17/月** |

---

## 故障排查

### 1. 服务无法访问

```bash
# 检查服务状态
sudo systemctl status stockguru-backend
pm2 status

# 检查端口占用
sudo netstat -tlnp | grep :8000
sudo netstat -tlnp | grep :3000

# 检查防火墙
sudo ufw status

# 检查 Nginx
sudo nginx -t
sudo systemctl status nginx
```

### 2. 内存不足

```bash
# 查看内存使用
free -h

# 创建 Swap 文件
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 永久生效
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### 3. 磁盘空间不足

```bash
# 查看磁盘使用
df -h

# 清理日志
sudo journalctl --vacuum-time=7d
pm2 flush

# 清理 npm 缓存
npm cache clean --force

# 清理 pip 缓存
pip cache purge
```

---

## 安全加固

### 1. SSH 安全

```bash
# 修改 SSH 配置
sudo nano /etc/ssh/sshd_config

# 禁用密码登录，只允许密钥登录
PasswordAuthentication no
PubkeyAuthentication yes

# 禁用 root 登录
PermitRootLogin no

# 重启 SSH
sudo systemctl restart sshd
```

### 2. 安装 Fail2Ban

```bash
# 安装
sudo apt install -y fail2ban

# 配置
sudo nano /etc/fail2ban/jail.local
```

内容：
```ini
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
```

```bash
# 启动
sudo systemctl start fail2ban
sudo systemctl enable fail2ban
```

### 3. 定期更新

```bash
# 创建更新脚本
sudo nano /usr/local/bin/system-update.sh
```

内容：
```bash
#!/bin/bash
apt update
apt upgrade -y
apt autoremove -y
```

```bash
# 添加执行权限
sudo chmod +x /usr/local/bin/system-update.sh

# 定时任务（每周日凌晨4点）
sudo crontab -e
# 添加: 0 4 * * 0 /usr/local/bin/system-update.sh
```

---

## 📚 相关资源

- [阿里云 ECS 文档](https://help.aliyun.com/product/25365.html)
- [阿里云函数计算文档](https://help.aliyun.com/product/50980.html)
- [阿里云容器服务文档](https://help.aliyun.com/product/85222.html)
- [Nginx 官方文档](https://nginx.org/en/docs/)
- [PM2 官方文档](https://pm2.keymetrics.io/docs/)

---

*最后更新: 2025-10-15*
