# æ‰¹é‡åŒæ­¥å¹¶å‘æ§åˆ¶

## âœ… åŠŸèƒ½è¯´æ˜

ç¡®ä¿åŒä¸€æ—¶é—´åªèƒ½è¿è¡Œä¸€ä¸ªæ‰¹é‡åŒæ­¥ä»»åŠ¡ï¼Œé˜²æ­¢ï¼š
- æ•°æ®åº“è¿æ¥è¿‡å¤š
- èµ„æºç«äº‰
- æ•°æ®å†²çª
- æ€§èƒ½ä¸‹é™

## ğŸ”’ å®ç°æ–¹æ¡ˆ

### 1. å…¨å±€çŠ¶æ€ç®¡ç†

```python
# åŒæ­¥é”
_sync_lock = threading.Lock()

# åŒæ­¥çŠ¶æ€æ ‡å¿—
_is_syncing = False
```

### 2. ä»»åŠ¡å¯åŠ¨æ£€æŸ¥

```python
@router.post("/sync/batch")
async def trigger_batch_sync(request: BatchSyncRequest):
    # æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œ
    global _is_syncing
    with _sync_lock:
        if _is_syncing:
            return {
                "status": "error",
                "message": "å·²æœ‰åŒæ­¥ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œè¯·ç­‰å¾…å½“å‰ä»»åŠ¡å®Œæˆåå†è¯•"
            }
    
    # å¯åŠ¨æ–°ä»»åŠ¡...
```

### 3. çŠ¶æ€è®¾ç½®

```python
def batch_sync_background(start_date_str, end_date_str, task_id):
    global _is_syncing
    
    try:
        # è®¾ç½®åŒæ­¥çŠ¶æ€
        with _sync_lock:
            _is_syncing = True
        
        # æ‰§è¡ŒåŒæ­¥...
        
    finally:
        # é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼ˆç¡®ä¿æ€»æ˜¯æ‰§è¡Œï¼‰
        with _sync_lock:
            _is_syncing = False
```

## ğŸ¯ å·¥ä½œæµç¨‹

### åœºæ™¯1ï¼šæ­£å¸¸å¯åŠ¨

```
ç”¨æˆ·Aç‚¹å‡»"å¼€å§‹åŒæ­¥"
â†“
æ£€æŸ¥ _is_syncing = False
â†“
å…è®¸å¯åŠ¨ï¼Œè®¾ç½® _is_syncing = True
â†“
æ‰§è¡ŒåŒæ­¥...
â†“
å®Œæˆåè®¾ç½® _is_syncing = False
```

### åœºæ™¯2ï¼šå¹¶å‘å†²çª

```
ç”¨æˆ·Açš„ä»»åŠ¡æ­£åœ¨è¿è¡Œ (_is_syncing = True)
â†“
ç”¨æˆ·Bç‚¹å‡»"å¼€å§‹åŒæ­¥"
â†“
æ£€æŸ¥ _is_syncing = True
â†“
è¿”å›é”™è¯¯ï¼š"å·²æœ‰åŒæ­¥ä»»åŠ¡æ­£åœ¨è¿è¡Œ"
â†“
ç”¨æˆ·Bçœ‹åˆ°æç¤ºï¼Œç­‰å¾…Aå®Œæˆ
```

### åœºæ™¯3ï¼šå¼‚å¸¸å¤„ç†

```
ä»»åŠ¡å¼€å§‹ (_is_syncing = True)
â†“
æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸
â†“
finally å—æ‰§è¡Œ
â†“
è®¾ç½® _is_syncing = False
â†“
ä¸‹ä¸€ä¸ªä»»åŠ¡å¯ä»¥å¯åŠ¨
```

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### 1. çº¿ç¨‹å®‰å…¨

ä½¿ç”¨ `threading.Lock()` ç¡®ä¿çŠ¶æ€æ£€æŸ¥å’Œè®¾ç½®çš„åŸå­æ€§ï¼š

```python
with _sync_lock:
    if _is_syncing:
        # è¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„
        return error
```

### 2. å¼‚å¸¸å®‰å…¨

ä½¿ç”¨ `finally` å—ç¡®ä¿çŠ¶æ€æ€»æ˜¯è¢«é‡Šæ”¾ï¼š

```python
try:
    _is_syncing = True
    # åŒæ­¥é€»è¾‘...
finally:
    _is_syncing = False  # æ€»æ˜¯æ‰§è¡Œ
```

### 3. å…¨å±€çŠ¶æ€

ä½¿ç”¨ `global` å…³é”®å­—ä¿®æ”¹å…¨å±€å˜é‡ï¼š

```python
global _is_syncing
with _sync_lock:
    _is_syncing = True
```

## ğŸ“Š ç”¨æˆ·ä½“éªŒ

### ç¬¬ä¸€ä¸ªç”¨æˆ·
```
ç‚¹å‡»"å¼€å§‹åŒæ­¥" â†’ âœ… ä»»åŠ¡å·²å¯åŠ¨ â†’ çœ‹åˆ°è¿›åº¦æ›´æ–°
```

### ç¬¬äºŒä¸ªç”¨æˆ·ï¼ˆä»»åŠ¡è¿è¡Œä¸­ï¼‰
```
ç‚¹å‡»"å¼€å§‹åŒæ­¥" â†’ âŒ å·²æœ‰åŒæ­¥ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œè¯·ç­‰å¾…å½“å‰ä»»åŠ¡å®Œæˆåå†è¯•
```

### ç¬¬äºŒä¸ªç”¨æˆ·ï¼ˆä»»åŠ¡å®Œæˆåï¼‰
```
ç‚¹å‡»"å¼€å§‹åŒæ­¥" â†’ âœ… ä»»åŠ¡å·²å¯åŠ¨ â†’ çœ‹åˆ°è¿›åº¦æ›´æ–°
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯•1ï¼šå•ä»»åŠ¡æ­£å¸¸è¿è¡Œ
```bash
# å¯åŠ¨ä»»åŠ¡
curl -X POST http://localhost:8000/api/v1/sync-status/sync/batch \
  -H "Content-Type: application/json" \
  -d '{"start_date": "2025-10-01", "end_date": "2025-10-03"}'

# é¢„æœŸï¼šè¿”å› task_idï¼Œä»»åŠ¡å¼€å§‹è¿è¡Œ
```

### æµ‹è¯•2ï¼šå¹¶å‘å†²çªæ£€æµ‹
```bash
# ç¬¬ä¸€ä¸ªä»»åŠ¡
curl -X POST http://localhost:8000/api/v1/sync-status/sync/batch \
  -H "Content-Type: application/json" \
  -d '{"start_date": "2025-10-01", "end_date": "2025-10-03"}'

# ç«‹å³å¯åŠ¨ç¬¬äºŒä¸ªä»»åŠ¡ï¼ˆç¬¬ä¸€ä¸ªè¿˜åœ¨è¿è¡Œï¼‰
curl -X POST http://localhost:8000/api/v1/sync-status/sync/batch \
  -H "Content-Type: application/json" \
  -d '{"start_date": "2025-10-04", "end_date": "2025-10-06"}'

# é¢„æœŸï¼šç¬¬äºŒä¸ªè¿”å›é”™è¯¯ "å·²æœ‰åŒæ­¥ä»»åŠ¡æ­£åœ¨è¿è¡Œ"
```

### æµ‹è¯•3ï¼šå¼‚å¸¸åçŠ¶æ€æ¢å¤
```bash
# å¯åŠ¨ä¸€ä¸ªä¼šå¤±è´¥çš„ä»»åŠ¡
# ç­‰å¾…å¤±è´¥
# å†æ¬¡å¯åŠ¨æ–°ä»»åŠ¡

# é¢„æœŸï¼šæ–°ä»»åŠ¡å¯ä»¥æ­£å¸¸å¯åŠ¨ï¼ˆçŠ¶æ€å·²é‡Šæ”¾ï¼‰
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æœåŠ¡é‡å¯
- çŠ¶æ€å­˜å‚¨åœ¨å†…å­˜ä¸­
- æœåŠ¡é‡å¯å `_is_syncing` é‡ç½®ä¸º `False`
- å¦‚æœä»»åŠ¡åœ¨è¿è¡Œä¸­é‡å¯ï¼ŒçŠ¶æ€ä¼šä¸¢å¤±

### 2. å¤šå®ä¾‹éƒ¨ç½²
- å½“å‰æ–¹æ¡ˆåªé€‚ç”¨äºå•å®ä¾‹
- å¦‚æœéƒ¨ç½²å¤šä¸ªåç«¯å®ä¾‹ï¼Œéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”
- å»ºè®®ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”

### 3. è¶…æ—¶å¤„ç†
- å¦‚æœä»»åŠ¡å¼‚å¸¸ç»ˆæ­¢ï¼ˆè¿›ç¨‹è¢«æ€æ­»ï¼‰
- çŠ¶æ€å¯èƒ½ä¸ä¼šè¢«é‡Šæ”¾
- å»ºè®®æ·»åŠ è¶…æ—¶æœºåˆ¶æˆ–å¥åº·æ£€æŸ¥

## ğŸš€ æœªæ¥ä¼˜åŒ–

### é€‰é¡¹1ï¼šåˆ†å¸ƒå¼é”ï¼ˆRedisï¼‰
```python
import redis

redis_client = redis.Redis()

def acquire_sync_lock():
    return redis_client.set('sync_lock', '1', nx=True, ex=3600)

def release_sync_lock():
    redis_client.delete('sync_lock')
```

### é€‰é¡¹2ï¼šæ•°æ®åº“é”
```sql
-- åˆ›å»ºé”è¡¨
CREATE TABLE sync_locks (
    lock_name VARCHAR(50) PRIMARY KEY,
    locked_at TIMESTAMP,
    locked_by VARCHAR(100)
);

-- è·å–é”
INSERT INTO sync_locks (lock_name, locked_at, locked_by)
VALUES ('batch_sync', NOW(), 'instance-1')
ON CONFLICT DO NOTHING;
```

### é€‰é¡¹3ï¼šä»»åŠ¡é˜Ÿåˆ—
```python
# ä½¿ç”¨ Celery æˆ– RQ
# ä»»åŠ¡é˜Ÿåˆ—è‡ªåŠ¨å¤„ç†å¹¶å‘
@celery.task
def batch_sync_task(start_date, end_date):
    # åŒæ­¥é€»è¾‘
    pass
```

## âœ… æ€»ç»“

å¹¶å‘æ§åˆ¶åŠŸèƒ½å·²å®Œæˆï¼š

1. **âœ… çº¿ç¨‹å®‰å…¨** - ä½¿ç”¨ threading.Lock
2. **âœ… å¼‚å¸¸å®‰å…¨** - finally å—é‡Šæ”¾çŠ¶æ€
3. **âœ… ç”¨æˆ·å‹å¥½** - æ¸…æ™°çš„é”™è¯¯æç¤º
4. **âœ… å¯é æ€§** - ç¡®ä¿çŠ¶æ€æ€»æ˜¯è¢«é‡Šæ”¾

**é™åˆ¶**ï¼š
- ä»…é€‚ç”¨äºå•å®ä¾‹éƒ¨ç½²
- æœåŠ¡é‡å¯ä¼šä¸¢å¤±çŠ¶æ€
- éœ€è¦æ‰‹åŠ¨å¤„ç†è¶…æ—¶æƒ…å†µ

**å»ºè®®**ï¼š
- çŸ­æœŸä½¿ç”¨å½“å‰æ–¹æ¡ˆå³å¯
- é•¿æœŸè€ƒè™‘å¼•å…¥ Redis åˆ†å¸ƒå¼é”
- æˆ–ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—ï¼ˆCelery/RQï¼‰
