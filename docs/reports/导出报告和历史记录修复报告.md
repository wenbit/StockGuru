# 导出报告和历史记录修复报告

**修复时间**: 2025-10-15 03:35  
**问题描述**: 导出报告和历史记录功能点击报错

---

## 🐛 问题分析

### 1. 导出报告错误
**错误信息**: `'dict' object has no attribute 'status'`

**原因**:
- `screening_service.get_task_result()` 返回的是字典类型
- 但代码中使用了 `result.status` 属性访问方式
- 应该使用 `result['status']` 字典访问方式

### 2. 历史记录显示错误
**错误信息**: TypeScript 类型错误

**原因**:
- 历史记录页面使用 `task.task_id` 作为创建时间显示
- 应该使用 `task.created_at`
- TypeScript 类型定义缺少 `created_at` 和 `completed_at` 字段

### 3. 导出报告无结果
**问题**: 即使修复了类型错误，导出报告仍然显示"没有筛选结果"

**原因**:
- 后端重启后，内存中的结果丢失
- Supabase 中虽然保存了任务记录，但没有保存结果数据
- 需要确保结果正确保存到数据库

---

## ✅ 修复方案

### 1. 修复导出报告 API

**文件**: `stockguru-web/backend/app/api/screening.py`

**修改内容**:
```python
# 修改前
if result.status != 'completed':
    raise HTTPException(status_code=400, detail="任务未完成，无法导出报告")

if not result.results or len(result.results) == 0:
    raise HTTPException(status_code=404, detail="没有筛选结果")

# 修改后
if result['status'] != 'completed':
    raise HTTPException(status_code=400, detail="任务未完成，无法导出报告")

if not result.get('results') or len(result['results']) == 0:
    raise HTTPException(status_code=404, detail="没有筛选结果")
```

### 2. 修复历史记录页面

**文件**: `frontend/app/history/page.tsx`

**修改内容**:
```typescript
// 修改前
{task.task_id ? formatDate(task.task_id) : '-'}

// 修改后
{task.created_at ? formatDate(task.created_at) : '-'}
```

### 3. 更新 TypeScript 类型定义

**文件**: `frontend/lib/api-client.ts`

**修改内容**:
```typescript
export interface TaskResult {
  task_id: string;
  status: 'pending' | 'running' | 'completed' | 'failed';
  progress: number;
  result_count?: number;
  results?: StockResult[];
  error_message?: string;
  created_at?: string;      // 新增
  completed_at?: string;    // 新增
}
```

---

## 🔍 根本原因分析

### 数据持久化问题

当前系统存在数据持久化不完整的问题：

1. **任务记录**: ✅ 已保存到 Supabase
2. **筛选结果**: ❌ 仅保存在内存中

**影响**:
- 后端重启后，历史任务的结果数据丢失
- 导出报告功能无法获取历史结果
- 历史记录页面只能看到任务状态，无法查看结果详情

### 解决方案

需要确保筛选结果正确保存到 Supabase：

**检查点**:
1. `screening_service.py` 中的结果保存逻辑
2. Supabase 连接是否正常
3. `results` 表是否正确插入数据

---

## 📝 测试验证

### 1. 测试导出报告

```bash
# 获取最新的任务ID
curl http://localhost:8000/api/v1/screening | jq '.[0].id'

# 测试导出报告
curl "http://localhost:8000/api/v1/screening/{task_id}/export"
```

**预期结果**: 返回 HTML 报告内容

### 2. 测试历史记录

访问: http://localhost:3000/history

**预期结果**:
- ✅ 显示任务列表
- ✅ 正确显示创建时间
- ✅ 点击任务可查看详情（如果有结果）

---

## ⚠️ 已知限制

### 1. 历史任务结果丢失

**问题**: 后端重启前的任务结果已丢失

**临时解决方案**:
- 重新运行一次筛选任务
- 新任务的结果会正确保存

**长期解决方案**:
- 修复 Supabase 结果保存逻辑
- 确保所有结果都持久化到数据库

### 2. 导出报告仅支持当前会话

**问题**: 只能导出当前会话中完成的任务

**解决方案**:
- 确保 Supabase 连接正常
- 修复结果保存逻辑
- 从数据库读取历史结果

---

## 🎯 后续优化建议

### 1. 数据持久化增强

```python
# 在 screening_service.py 中
# 确保每次保存结果时都同时保存到 Supabase 和内存

# 保存到内存
_results_store[task_id] = results

# 保存到 Supabase
if supabase and results:
    try:
        # 批量插入结果
        supabase.table("results").insert(results).execute()
        logger.info(f"结果已保存到 Supabase: {len(results)} 条")
    except Exception as e:
        logger.error(f"保存结果到 Supabase 失败: {e}")
        # 不抛出异常，允许继续使用内存存储
```

### 2. 错误处理增强

```python
# 在导出报告 API 中添加更详细的错误信息
if not result.get('results'):
    logger.warning(f"任务 {task_id} 没有结果数据")
    raise HTTPException(
        status_code=404, 
        detail=f"任务 {task_id} 没有筛选结果。可能原因：1) 任务失败 2) 后端重启导致数据丢失"
    )
```

### 3. 前端用户提示

```typescript
// 在历史记录页面添加提示
{task.result_count === 0 && task.status === 'completed' && (
  <div className="mt-2 p-2 bg-yellow-50 rounded text-sm text-yellow-700">
    ⚠️ 此任务的结果数据已丢失，请重新运行筛选
  </div>
)}
```

---

## 📊 修复状态

| 问题 | 状态 | 说明 |
|------|------|------|
| 导出报告 API 类型错误 | ✅ 已修复 | 使用字典访问方式 |
| 历史记录显示错误 | ✅ 已修复 | 使用 created_at 字段 |
| TypeScript 类型定义 | ✅ 已修复 | 添加缺失字段 |
| 数据持久化问题 | ⚠️ 待优化 | 需要修复 Supabase 保存逻辑 |

---

## 🚀 使用说明

### 导出报告

1. 在首页完成一次筛选
2. 等待任务完成（进度 100%）
3. 点击"导出报告"按钮
4. 浏览器会打开新标签页显示 HTML 报告

### 查看历史记录

1. 点击首页右上角的"历史记录"按钮
2. 查看所有历史任务列表
3. 点击任务卡片查看详情（如果有结果）

---

## 📝 总结

### 已修复
- ✅ 导出报告 API 的类型错误
- ✅ 历史记录页面的显示错误
- ✅ TypeScript 类型定义不完整

### 待优化
- ⚠️ Supabase 结果数据持久化
- ⚠️ 后端重启后的数据恢复
- ⚠️ 错误提示和用户引导

### 建议
- 尽快修复 Supabase 连接和数据保存逻辑
- 添加数据备份和恢复机制
- 增强错误处理和用户提示

---

*最后更新: 2025-10-15 03:35*
