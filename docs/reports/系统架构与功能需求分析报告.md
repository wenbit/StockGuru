# StockGuru 系统架构与功能需求分析报告

**生成时间**: 2025-10-15 03:28  
**项目版本**: v0.9 (89% 完成度)

---

## 1. 项目概述

### 核心定位
**StockGuru** 是一款股票短线复盘助手，通过量化筛选模型自动化筛选强势股，并生成可视化复盘报告。

### 核心价值
- **效率提升**: 将数小时复盘工作缩短至几分钟
- **量化筛选**: 基于成交额、热度、动量等多维度指标
- **可视化**: K线图、技术指标直观展示
- **自动化**: 一键筛选，后台处理，实时进度反馈

---

## 2. 技术架构

### 整体架构
```
用户层 (Browser)
    ↕
前端层 (Next.js 14 + TypeScript + Tailwind CSS)
    ↕ REST API
后端层 (FastAPI + Python 3.12)
    ↕
服务层 (ScreeningService + DataFetcher + StockFilter + MomentumCalculator)
    ↕
数据层 (pywencai + akshare + Supabase + 内存存储)
```

### 技术栈

**前端**:
- Next.js 14 (React 框架)
- TypeScript (类型安全)
- Tailwind CSS (样式)
- Recharts (图表)

**后端**:
- FastAPI (异步 Web 框架)
- Python 3.12
- pandas (数据处理)
- scikit-learn (线性回归)
- pywencai (成交额/热度)
- akshare (K线/股票信息)

**数据库**:
- Supabase (PostgreSQL)
- 内存存储 (临时缓存)

---

## 3. 核心功能模块

### 3.1 数据获取模块 (DataFetcher)

**职责**: 从多个数据源获取股票数据

**核心方法**:
- `get_volume_top_stocks()` - 获取成交额 Top100
- `get_hot_top_stocks()` - 获取热度 Top100
- `get_stock_daily_data()` - 获取K线数据（多数据源降级）
- `get_stock_info()` - 获取股票信息（名称、行业、上市日期）

**数据源策略**:
1. akshare (主数据源)
2. 东方财富 API (备用1)
3. 新浪财经 API (备用2)
4. 模拟数据 (降级)

### 3.2 股票筛选模块 (StockFilter)

**综合评分算法**:
```
1. 找交集: common = volume_top_100 ∩ hot_top_100
2. Min-Max 标准化
3. 加权计算: score = 0.5×volume + 0.5×hot
4. 排序取前30名
```

**过滤规则**:
- 排除 ST 股票
- 排除次新股
- 排除涨幅过大股票

### 3.3 动量计算模块 (MomentumCalculator)

**线性回归动量算法**:
```
1. 获取过去25天收盘价
2. 计算相对价格: relative_price = price / price[0]
3. 线性回归: y = ax + b
4. 动量分 = slope × R² × 10000
```

**数学原理**:
- **slope**: 衡量上涨速度
- **R²**: 衡量趋势稳定性 (0-1)
- 高分 = 强势上涨 + 趋势稳定

### 3.4 技术指标模块 (TechnicalIndicators)

**已实现指标**:
- MA (移动平均线): MA5, MA10, MA20
- MACD (指数平滑异同移动平均线)
- RSI (相对强弱指标)
- BOLL (布林带)
- KDJ (随机指标)
- 成交量均线

---

## 4. 数据流程

### 完整筛选流程
```
1. 用户点击"一键筛选" → POST /api/v1/screening
2. 创建任务 → 返回 task_id
3. 后台执行:
   ├─ 10%: 获取成交额数据 (pywencai)
   ├─ 30%: 获取热度数据 (pywencai)
   ├─ 50%: 计算综合评分 (前30名)
   ├─ 70%: 并发获取K线数据 (akshare)
   ├─ 85%: 计算动量分数
   ├─ 90%: 保存结果 (Supabase + 内存)
   └─ 100%: 完成
4. 前端轮询 → GET /api/v1/screening/{task_id}
5. 显示结果 → 卡片式布局
```

---

## 5. 已完成功能 ✅

### 核心功能
- ✅ 智能筛选系统 (成交额 + 热度 + 动量)
- ✅ Web 界面 (首页 + 详情页 + 历史记录)
- ✅ K线图可视化 (Recharts)
- ✅ 技术指标 (MA/MACD/RSI/BOLL/KDJ)
- ✅ 实时进度显示
- ✅ 后台异步任务处理
- ✅ 多数据源降级策略
- ✅ 并发数据获取优化
- ✅ 状态持久化 (localStorage + Supabase)
- ✅ 行业信息正确显示

### API 接口
```
POST   /api/v1/screening              # 创建筛选任务
GET    /api/v1/screening/{task_id}    # 获取任务结果
GET    /api/v1/screening              # 获取任务列表
GET    /api/v1/screening/{task_id}/export  # 导出HTML报告
GET    /api/v1/stock/{code}/kline     # 获取K线数据
GET    /api/v1/stock/{code}/info      # 获取股票信息
GET    /api/v1/stock/{code}/indicators # 获取技术指标
```

---

## 6. 待完成需求

### 中优先级 (本周)
1. **卡片式布局优化** (2-3h)
   - 优化卡片样式和交互
   - 添加排序和筛选功能

2. **股票详情页增强** (2-3h)
   - 添加更多技术指标图表
   - 添加基本面信息

### 低优先级 (可选)
3. **HTML 报告导出** (3-4h)
4. **命令行工具** (2-3h)
5. **性能优化** (2-3h)

---

## 7. 技术亮点

### 架构设计
- ✨ 前后端分离 (Next.js + FastAPI)
- ✨ 模块化设计 (高内聚低耦合)
- ✨ 多数据源策略 (提高可用性)

### 算法优化
- ✨ Min-Max 标准化 (消除量纲影响)
- ✨ 线性回归动量 (科学量化趋势)
- ✨ 并发获取优化 (ThreadPoolExecutor)

### 用户体验
- ✨ 实时进度反馈 (0-100%)
- ✨ 状态持久化 (localStorage)
- ✨ 响应式设计 (支持移动端)

---

## 8. 项目目录结构

```
StockGuru/
├── stockguru-web/backend/      # FastAPI 后端
│   ├── app/
│   │   ├── main.py            # 应用入口
│   │   ├── api/               # API 路由
│   │   ├── services/          # 业务逻辑
│   │   │   ├── screening_service.py
│   │   │   └── modules/       # 核心算法
│   │   │       ├── data_fetcher.py
│   │   │       ├── stock_filter.py
│   │   │       ├── momentum_calculator.py
│   │   │       └── technical_indicators.py
│   │   └── core/              # 配置
│   └── requirements.txt
│
├── frontend/                   # Next.js 前端
│   ├── app/
│   │   ├── page.tsx           # 首页
│   │   ├── history/page.tsx   # 历史记录
│   │   └── stock/[code]/page.tsx  # 详情页
│   ├── components/
│   │   ├── StockCard.tsx      # 股票卡片
│   │   └── StockChart.tsx     # K线图
│   └── package.json
│
├── prd.md                      # 产品需求文档
├── design.md                   # 技术设计文档
├── README.md                   # 项目说明
└── 未完成需求清单.md           # 待办清单
```

---

## 9. 配置参数

### 筛选参数
```python
VOLUME_TOP_N = 100      # 成交额排名范围
HOT_TOP_N = 100         # 热度排名范围
FINAL_TOP_N = 30        # 综合评分取前N名
MOMENTUM_DAYS = 25      # 动量计算周期
MOMENTUM_TOP_N = 10     # 最终筛选数量
```

### 评分权重
```python
WEIGHT_VOLUME = 0.5     # 成交额权重
WEIGHT_HOT = 0.5        # 热度权重
```

### 过滤规则
```python
EXCLUDE_ST = True       # 排除ST股
EXCLUDE_NEW_STOCK_DAYS = 60  # 排除上市N天内次新股
```

---

## 10. 系统优化建议

### 性能优化
1. **数据缓存**: 使用 Redis 缓存热门股票数据
2. **请求去重**: 避免重复请求同一股票
3. **数据预加载**: 预加载热门股票K线数据
4. **CDN 加速**: 静态资源使用 CDN

### 功能增强
1. **回测功能**: 验证策略历史表现
2. **多策略支持**: 允许用户选择不同筛选策略
3. **实时监控**: 盘中实时更新强势股列表
4. **消息推送**: 邮件或微信推送报告

### 代码质量
1. **单元测试**: 覆盖核心算法模块
2. **集成测试**: 端到端测试完整流程
3. **代码审查**: 定期 Code Review
4. **文档完善**: API 文档和开发文档

---

## 11. 总结

### 项目状态
- **完成度**: 89%
- **核心功能**: 已完成
- **用户体验**: 良好
- **技术债务**: 中等

### 优势
- ✅ 架构清晰，易于维护
- ✅ 算法科学，结果可靠
- ✅ 用户体验好，操作简单
- ✅ 技术栈现代，性能优秀

### 改进空间
- ⚠️ 前端页面待完善
- ⚠️ 性能优化空间大
- ⚠️ 测试覆盖率待提高
- ⚠️ 文档待补充

### 下一步计划
1. 完成中优先级功能 (8-11h)
2. 性能优化 (2-3h)
3. 测试完善 (4-6h)
4. 文档补充 (2-3h)

**预计 1-2 周可达到 100% 完成度**

---

*最后更新: 2025-10-15 03:28*
