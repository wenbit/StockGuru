# PDF 导出功能实现说明

**实现时间**: 2025-10-15 03:47  
**功能**: 通过浏览器打印功能导出 PDF 报告

---

## ✨ 功能概述

实现了一个简单而有效的 PDF 导出方案：
- 🖨️ **打印友好页面**: 专门优化的打印布局
- 📕 **浏览器原生**: 使用浏览器的"打印"功能保存为 PDF
- 🎨 **完美样式**: 打印样式完整保留
- 🚀 **零依赖**: 不需要任何后端 PDF 库

---

## 🛠️ 技术方案

### 为什么选择浏览器打印？

**原因**:
1. **系统依赖问题**: WeasyPrint、xhtml2pdf 等库需要系统级依赖（GTK+、Cairo 等）
2. **安装复杂**: 在 macOS 上安装这些依赖非常困难
3. **浏览器原生**: 所有现代浏览器都内置了强大的打印功能
4. **样式完美**: 浏览器打印能完美保留 CSS 样式

### 实现方式

#### 1. 后端 API

**端点**: `GET /api/v1/screening/{task_id}/export/print`

**功能**: 生成打印友好的 HTML 页面

**特点**:
- 📄 清晰的表格布局
- 🎨 打印专用 CSS 样式
- 🖨️ 一键打印按钮
- 📱 响应式设计

#### 2. 打印样式

使用 CSS `@media print` 规则：

```css
@media print {
    @page {
        size: A4;
        margin: 1.5cm;
    }
    .no-print {
        display: none !important;
    }
    table {
        page-break-inside: avoid;
    }
}
```

#### 3. 前端按钮

两个导出选项：
- **📄 HTML报告**: 完整的交互式报告
- **🖨️ 打印/PDF**: 打印友好版本

---

## 📝 使用方法

### 1. 完成筛选任务
在首页进行股票筛选，等待任务完成

### 2. 点击"打印/PDF"按钮
会在新标签页打开打印友好的报告页面

### 3. 保存为 PDF

**方法 1: 使用打印按钮**
- 点击页面右上角的"🖨️ 打印/保存为PDF"按钮
- 浏览器会打开打印对话框

**方法 2: 使用快捷键**
- macOS: `Cmd + P`
- Windows/Linux: `Ctrl + P`

### 4. 在打印对话框中

**macOS**:
1. 点击"PDF"下拉菜单
2. 选择"存储为 PDF"
3. 选择保存位置
4. 点击"存储"

**Windows**:
1. 选择打印机为"Microsoft Print to PDF"
2. 点击"打印"
3. 选择保存位置

**Chrome/Edge**:
1. 目标打印机选择"另存为 PDF"
2. 点击"保存"

---

## 🎨 报告内容

### 页面布局

```
┌─────────────────────────────────────┐
│  📈 StockGuru 股票筛选报告           │
│  ─────────────────────────────────  │
│                                     │
│  生成时间: 2025-10-15 03:47:00      │
│  筛选日期: 2025-10-14               │
│  筛选结果: 共 10 只股票             │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ 排名 | 代码 | 名称 | 动量分... │ │
│  ├───────────────────────────────┤ │
│  │  1   | 601212 | 白银有色 | ... │ │
│  │  2   | 000001 | 平安银行 | ... │ │
│  │  ...                          │ │
│  └───────────────────────────────┘ │
│                                     │
│  ⚠️ 免责声明: ...                   │
└─────────────────────────────────────┘
```

### 表格列

| 列名 | 说明 |
|------|------|
| 排名 | 最终排名 |
| 股票代码 | 6位数字代码 |
| 股票名称 | 中文名称 |
| 动量分数 | 动量得分 |
| 综合评分 | 综合评分 |
| 最新价 | 收盘价 |
| 涨跌幅 | 涨跌百分比 |
| 成交量 | 成交量 |

---

## 🎯 优势对比

| 特性 | 后端生成 PDF | 浏览器打印 |
|------|-------------|-----------|
| 系统依赖 | 需要 GTK+/Cairo | 无需依赖 ✅ |
| 安装难度 | 困难 | 简单 ✅ |
| 样式保留 | 90% | 100% ✅ |
| 文件大小 | 较大 | 适中 ✅ |
| 生成速度 | 慢 (5-10秒) | 快 (即时) ✅ |
| 用户控制 | 无 | 完全控制 ✅ |
| 跨平台 | 复杂 | 完美 ✅ |

---

## 📊 打印设置建议

### 推荐设置

**纸张**:
- 大小: A4
- 方向: 纵向

**边距**:
- 上下左右: 1.5cm

**选项**:
- ✅ 背景图形（保留颜色）
- ✅ 页眉和页脚（可选）

### 高级设置

**缩放**:
- 100%（默认）
- 如果内容过宽，可以调整为 90% 或 85%

**颜色**:
- 彩色（推荐）- 保留涨跌幅颜色
- 黑白 - 节省墨水

---

## 🔧 技术细节

### CSS 打印样式

```css
@media print {
    /* 页面设置 */
    @page {
        size: A4;
        margin: 1.5cm;
    }
    
    /* 隐藏不打印元素 */
    .no-print {
        display: none !important;
    }
    
    /* 避免表格被截断 */
    table {
        page-break-inside: avoid;
    }
    
    /* 强制分页 */
    .page-break {
        page-break-after: always;
    }
}
```

### 字体支持

自动使用系统字体：
- macOS: PingFang SC
- Windows: Microsoft YaHei
- Linux: Noto Sans CJK

### 颜色处理

涨跌幅颜色：
- 上涨: 红色 (#ef4444)
- 下跌: 绿色 (#10b981)

---

## 📝 修改文件清单

| 文件 | 修改内容 | 状态 |
|------|---------|------|
| `stockguru-web/backend/app/api/screening.py` | 添加打印版 API | ✅ 已实现 |
| `frontend/app/page.tsx` | 添加打印/PDF 按钮 | ✅ 已实现 |

---

## 🎓 使用技巧

### 1. 批量打印

如果需要打印多个报告：
1. 在多个标签页中打开不同的报告
2. 使用浏览器的"打印预览"功能
3. 一次性打印或保存

### 2. 自定义样式

可以在打印对话框中：
- 调整缩放比例
- 选择打印页面范围
- 添加页眉页脚

### 3. 快速预览

使用打印预览功能（不实际打印）：
- macOS: `Cmd + P` 后点击"预览"
- Windows: 打印对话框中选择"预览"

---

## ⚠️ 注意事项

### 1. 浏览器兼容性

**支持的浏览器**:
- ✅ Chrome/Edge (推荐)
- ✅ Firefox
- ✅ Safari
- ⚠️ IE (不支持)

### 2. 打印质量

**建议**:
- 使用 Chrome 或 Edge 浏览器
- 选择"另存为 PDF"而不是实际打印
- 保留背景图形选项

### 3. 文件大小

- 一般报告: 50-200 KB
- 包含大量数据: 200-500 KB

---

## 🚀 未来优化

### 1. 添加图表

在打印版中添加简化的图表：
```html
<div class="chart-container">
    <!-- 使用 SVG 或 Canvas 生成简单图表 -->
</div>
```

### 2. 多页面支持

自动分页，每页显示固定数量的股票：
```css
.stock-group:nth-child(10n) {
    page-break-after: always;
}
```

### 3. 自定义模板

允许用户选择不同的打印模板：
- 简洁版
- 详细版
- 图表版

---

## 📚 相关资源

### 文档
- [CSS Print 规范](https://www.w3.org/TR/css-print/)
- [MDN: @media print](https://developer.mozilla.org/en-US/docs/Web/CSS/@media)
- [Chrome 打印 API](https://developer.chrome.com/docs/extensions/reference/printing/)

### 工具
- Chrome DevTools: 打印预览调试
- Firefox: 打印设置
- Safari: 导出为 PDF

---

## ✅ 测试验证

### 1. 功能测试

```bash
# 访问打印版 API
curl "http://localhost:8000/api/v1/screening/{task_id}/export/print"
```

### 2. 浏览器测试

1. 完成一次筛选
2. 点击"打印/PDF"按钮
3. 验证页面布局
4. 测试打印功能
5. 保存为 PDF 并检查

### 3. 样式测试

在浏览器中：
1. 按 `Cmd/Ctrl + P` 打开打印预览
2. 检查样式是否正确
3. 验证表格不被截断
4. 确认颜色正确显示

---

## 📊 功能对比

| 功能 | HTML报告 | 打印/PDF |
|------|----------|---------|
| 查看方式 | 浏览器 | 浏览器 + PDF |
| 交互性 | 支持 | 静态 |
| 打印效果 | 一般 | 优秀 ✅ |
| 文件大小 | 小 | 小 ✅ |
| 分享便利 | 链接 | PDF 文件 ✅ |
| 离线查看 | 需保存 | PDF 直接打开 ✅ |

---

## 📝 总结

### 已实现
- ✅ 打印友好的 HTML 页面
- ✅ 专用打印 CSS 样式
- ✅ 一键打印按钮
- ✅ 完美的样式保留

### 优势
- 🚀 无需后端依赖
- 💯 100% 样式保留
- 🎨 用户可自定义
- 📱 跨平台兼容

### 使用建议
- **HTML报告**: 在线查看和分析
- **打印/PDF**: 存档、打印和分享

---

*最后更新: 2025-10-15 03:47*
