# 批量同步脚本使用说明

## 功能特性

### ✅ 核心功能
1. **批量同步多个日期** - 自动处理多个交易日的数据同步
2. **断点续传** - 自动跳过已同步的股票，节省时间
3. **智能重试** - 每个日期最多重试3次
4. **实时监控** - 检测持续错误并及时中断
5. **自动更新状态表** - 同步完成后自动更新 `daily_sync_status`
6. **失败后继续** - 某个日期失败后自动跳过，继续下一个日期
7. **周末自动跳过** - 自动识别并跳过周末

### 🔧 错误处理机制

#### 1. 实时错误监控
- 监控同步进程的输出
- 检测错误关键词：`❌`、`ERROR`、`失败`
- 30秒时间窗口内累计错误
- 超过10次错误自动终止当前日期同步

#### 2. 三次重试机制
- 每个日期最多尝试3次
- 失败后等待5秒再重试
- 3次都失败后更新状态表为 `failed`
- 自动跳过失败日期，继续下一个

#### 3. 状态表自动更新
无论成功或失败，都会更新 `daily_sync_status` 表：
- `status`: success / failed
- `total_records`: 总记录数
- `success_count`: 成功数量
- `error_message`: 错误信息（失败时）
- `start_time` / `end_time`: 开始/结束时间
- `duration_seconds`: 耗时（秒）

## 使用方法

### 方式1: 指定日期列表
```bash
python3 scripts/batch_sync_dates.py --dates 2025-10-14 2025-10-16 2025-10-17
```

### 方式2: 指定日期范围
```bash
python3 scripts/batch_sync_dates.py --start 2025-10-10 --end 2025-10-16
```

## 执行流程

```
开始批量同步
    ↓
遍历每个日期
    ↓
检查是否为交易日 → 否 → 跳过（周末）
    ↓ 是
检查是否已同步 → 是 → 跳过（已完成）
    ↓ 否
尝试1: 启动同步进程
    ↓
实时监控输出
    ↓
检测到持续错误？ → 是 → 终止进程，尝试2
    ↓ 否
同步完成
    ↓
查询数据库验证
    ↓
成功？ → 是 → 更新状态表（success）→ 下一个日期
    ↓ 否
尝试2: 重新同步
    ↓
... (重复上述流程)
    ↓
尝试3: 最后一次
    ↓
仍然失败？ → 是 → 更新状态表（failed）→ 下一个日期
    ↓
所有日期处理完成
    ↓
输出统计报告
```

## 输出示例

### 成功场景
```
================================================================================
批量同步任务开始
待同步日期: 3 个
================================================================================

📅 处理日期 1/3: 2025-10-14
✅ 2025-10-14 已同步完成（5,274 条记录），跳过
✅ 2025-10-14 处理完成

📅 处理日期 2/3: 2025-10-16
🔄 尝试 1/3
[实时同步输出...]
✅ 2025-10-16 同步成功
   总数: 5,267
   成功: 5,267
   耗时: 480 秒 (8.0 分钟)
✅ 2025-10-16 处理完成

📅 处理日期 3/3: 2025-10-17
⚠️  2025-10-17 是周末，跳过
✅ 2025-10-17 处理完成

================================================================================
批量同步任务完成
================================================================================
✅ 成功: 3
❌ 失败: 0
================================================================================
```

### 失败重试场景
```
📅 处理日期 1/3: 2025-10-15

🔄 尝试 1/3
[同步输出...]
⚠️  检测到错误 (1/10)
⚠️  检测到错误 (2/10)
...
⚠️  检测到错误 (10/10)
❌ 2025-10-15 持续出现错误（10次），终止同步
⚠️  尝试 1 失败，等待5秒后重试...

🔄 尝试 2/3
[同步输出...]
✅ 2025-10-15 同步成功
   总数: 5,274
   成功: 5,274
   耗时: 520 秒 (8.7 分钟)
✅ 2025-10-15 处理完成
```

### 彻底失败场景
```
📅 处理日期 2/3: 2025-10-18

🔄 尝试 1/3
❌ 尝试 1 失败
⚠️  尝试 1 失败，等待5秒后重试...

🔄 尝试 2/3
❌ 尝试 2 失败
⚠️  尝试 2 失败，等待5秒后重试...

🔄 尝试 3/3
❌ 尝试 3 失败
❌ 2025-10-18 同步失败（已重试3次）
✅ 2025-10-18 同步状态已更新
⚠️  2025-10-18 失败，已更新状态表，继续下一个日期

================================================================================
批量同步任务完成
================================================================================
✅ 成功: 2
❌ 失败: 1
失败日期: 2025-10-18
================================================================================
```

## 配置参数

### 可调整参数（在代码中）

```python
# 最大重试次数
max_retries = 3

# 错误检测阈值
max_error_count = 10

# 错误时间窗口（秒）
error_window = 30

# 重试等待时间（秒）
retry_wait = 5

# 日期间隔等待时间（秒）
date_interval = 2
```

## 数据库状态表

### daily_sync_status 表结构
```sql
CREATE TABLE daily_sync_status (
    id SERIAL PRIMARY KEY,
    sync_date DATE NOT NULL UNIQUE,
    status VARCHAR(20),           -- 'success' / 'failed' / 'pending'
    total_records INTEGER,
    success_count INTEGER,
    failed_count INTEGER,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    duration_seconds INTEGER,
    error_message TEXT,
    remarks TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

## 最佳实践

### 1. 日常使用
```bash
# 同步最近一周
python3 scripts/batch_sync_dates.py --start 2025-10-10 --end 2025-10-16
```

### 2. 补充缺失数据
```bash
# 查询缺失日期后，指定同步
python3 scripts/batch_sync_dates.py --dates 2025-10-12 2025-10-15
```

### 3. 重新同步失败日期
```bash
# 先删除失败日期的数据
DELETE FROM daily_stock_data WHERE trade_date = '2025-10-15';
DELETE FROM daily_sync_status WHERE sync_date = '2025-10-15';

# 重新同步
python3 scripts/batch_sync_dates.py --dates 2025-10-15
```

## 故障排查

### 问题1: 连接超时
**现象**: 同步到一半时出现 `connection already closed`

**解决**: 已内置定期重连机制（每5分钟），无需手动处理

### 问题2: 持续错误
**现象**: 30秒内出现10次以上错误

**原因**: 
- 网络不稳定
- baostock服务异常
- 数据库连接问题

**解决**: 脚本会自动重试3次，如果仍然失败会跳过该日期

### 问题3: 数据不完整
**现象**: 同步完成但记录数偏少

**检查**:
```sql
SELECT sync_date, success_count 
FROM daily_sync_status 
WHERE sync_date BETWEEN '2025-10-10' AND '2025-10-16'
ORDER BY sync_date;
```

**解决**: 删除该日期数据后重新同步

## 技术细节

### 断点续传实现
```python
# 1. 查询已同步的股票
synced_stocks = get_synced_stocks(date_str)

# 2. 过滤掉已同步的股票
stocks = [s for s in all_stocks if s['code'] not in synced_stocks]

# 3. 只同步剩余股票
for stock in stocks:
    sync_stock_data(stock, date_str)
```

### 错误监控实现
```python
# 实时读取进程输出
while True:
    line = process.stdout.readline()
    
    # 检测错误关键词
    if '❌' in line or 'ERROR' in line:
        error_count += 1
        
        # 超过阈值终止进程
        if error_count >= max_error_count:
            process.terminate()
            return False
```

### 定期重连实现
```python
# 记录连接时间
self.last_reconnect_time = time.time()

# 每次入库前检查
def check_and_reconnect():
    elapsed = time.time() - self.last_reconnect_time
    if elapsed > 300:  # 5分钟
        reconnect()
```

## 相关文件

- `scripts/batch_sync_dates.py` - 批量同步主脚本
- `scripts/test_copy_sync.py` - 单日同步脚本（被调用）
- `scripts/test_batch_sync.sh` - 测试脚本
- `docs/批量同步使用说明.md` - 本文档

## 更新日志

### v1.0 (2025-10-17)
- ✅ 实现批量同步功能
- ✅ 添加断点续传
- ✅ 添加实时错误监控
- ✅ 添加三次重试机制
- ✅ 添加自动状态表更新
- ✅ 添加失败后继续功能
