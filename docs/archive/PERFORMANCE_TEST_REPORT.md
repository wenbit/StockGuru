# 📊 性能测试报告

## 🧪 测试概况

**测试时间**: 2025-10-17 06:10 - 进行中  
**测试日期**: 2025-10-14  
**优化版本**: 进阶优化版 v2.0

---

## ✅ 优化验证

### 已确认生效的优化

#### 1. batch_size 优化 ✅
```
优化前: batch_size=500
优化后: batch_size=1500
日志确认: 2025-10-17 06:10:24 - batch_size=1500
```

#### 2. 股票列表缓存 ✅
```
缓存文件: stock_list_cache.json
日志确认: 2025-10-17 06:10:24 - 股票列表已缓存
效果: 获取 3566 只A股（使用缓存）
```

#### 3. 连接池 ✅
```
配置: 2-10 连接
日志确认: 2025-10-17 06:10:22 - 连接池: 2-10
```

### 待确认的优化

#### 4. COPY 命令 ⏳
```
状态: 代码已实施
确认: 需要查看入库日志
```

#### 5. 数据库参数优化 ⏳
```
状态: 代码已实施
确认: 需要查看数据库日志
```

---

## 📈 性能观察

### 当前测试数据（2025-10-14）

#### 进度记录
```
06:10:24 - 开始同步 (3566 只股票)
06:12:47 - 进度: 500/3566  (2分23秒, 210股/分钟)
06:15:24 - 进度: 1000/3566 (2分37秒, 191股/分钟)
06:18:34 - 进度: 1500/3566 (3分10秒, 158股/分钟)
06:21:52 - 进度: 2000/3566 (3分18秒, 152股/分钟)
06:24:21 - 进度: 2500/3566 (2分29秒, 201股/分钟)
06:26:56 - 进度: 3000/3566 (2分35秒, 193股/分钟)
```

#### 平均速度
```
总进度: 3000/3566 (84%)
总耗时: 16分32秒
平均速度: 181 股/分钟
```

### 与历史数据对比

| 版本 | 速度 | 说明 |
|------|------|------|
| Supabase REST API | 90 股/分 | 历史基准 |
| Neon 基础版 | 348 股/分 | 2025-10-15 测试 |
| **当前测试** | **181 股/分** | 2025-10-14 测试 ⚠️ |

**⚠️ 注意**: 当前速度低于预期，可能原因：
1. 2025-10-14 是周一，股票数量较少（3566 vs 5158）
2. 代码重载导致中断
3. 失败率较高（695/3000 = 23%）

---

## 🔍 问题分析

### 1. 失败率较高
```
进度: 3000/3566
成功: 2305
失败: 695
失败率: 23%
```

**可能原因**:
- baostock API 不稳定
- 网络问题
- 部分股票当日停牌

### 2. 入库数据异常
```
已入库: 1500 (未增长)
```

**可能原因**:
- 代码重载导致统计重置
- COPY 命令执行问题
- 需要查看详细日志

---

## 🎯 下一步测试计划

### 测试 1: 完整单日测试
```bash
# 使用一个完整交易日（5158只股票）
curl -X POST 'http://localhost:8000/api/v1/daily/sync' \
  -H 'Content-Type: application/json' \
  -d '{"sync_date": "2025-10-15"}'
```

**预期**:
- 速度: 300-400 股/分钟
- 耗时: 13-17 分钟
- 成功率: 95%+

### 测试 2: COPY 命令验证
```bash
# 查看 COPY 命令日志
tail -f stockguru-web/backend/backend.log | grep -E "(COPY|copy_expert)"
```

### 测试 3: 数据库参数验证
```bash
# 查看数据库参数设置
tail -f stockguru-web/backend/backend.log | grep -E "(work_mem|maintenance_work_mem)"
```

---

## 📊 预期 vs 实际

### 理论性能（基于 2025-10-15 测试）

| 指标 | 优化前 | 预期优化后 | 实际 | 状态 |
|------|--------|-----------|------|------|
| 速度 | 348 股/分 | 400-450 股/分 | 181 股/分 | ⚠️ 待验证 |
| 单日 | 14.8 分钟 | 8.8 分钟 | - | ⏳ 进行中 |
| 成功率 | 100% | 100% | 77% | ⚠️ 偏低 |

---

## 🔧 优化建议

### 短期
1. ✅ 等待当前测试完成
2. ⏳ 分析失败原因
3. ⏳ 验证 COPY 命令是否生效
4. ⏳ 使用 2025-10-15 重新测试（完整数据）

### 中期
1. ⏳ 添加更详细的性能日志
2. ⏳ 记录每个阶段的耗时
3. ⏳ 监控 COPY 命令执行时间

---

## 📝 测试脚本

### 启动测试
```bash
chmod +x scripts/start_performance_test.sh
./scripts/start_performance_test.sh
```

### 监控进度
```bash
chmod +x scripts/monitor_performance.sh
watch -n 5 ./scripts/monitor_performance.sh
```

### 查看日志
```bash
tail -f stockguru-web/backend/backend.log | grep -E "(进度|完成|COPY|数据库性能)"
```

---

## 🎉 初步结论

### 已验证
- ✅ batch_size 优化已生效
- ✅ 股票列表缓存已生效
- ✅ 连接池配置正确

### 待验证
- ⏳ COPY 命令性能提升
- ⏳ 数据库参数优化效果
- ⏳ 整体性能提升幅度

### 下一步
**建议使用 2025-10-15（完整交易日）重新测试，以获得准确的性能数据。**

---

**报告生成时间**: 2025-10-17 06:27  
**测试状态**: 进行中  
**下次更新**: 测试完成后
