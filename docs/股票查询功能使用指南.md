# 📊 股票查询功能使用指南

## 功能概述

股票查询功能允许用户查询历史交易数据，支持按日期范围和涨跌幅进行筛选，适用于复盘分析和数据研究。

---

## 核心特性

### 1. 数据查询
- ✅ 按日期范围查询
- ✅ 按涨跌幅筛选（支持正负值）
- ✅ 按涨跌幅排序
- ✅ 分页展示
- ✅ 数据导出（计划中）

### 2. 数据同步
- ✅ 每晚22点自动同步
- ✅ 失败自动重试（每小时）
- ✅ 交易日自动判断
- ✅ 手动触发同步
- ✅ 历史数据初始化

### 3. 数据来源
- **主要数据源**: akshare（东方财富）
- **数据范围**: 全市场A股（约5000只）
- **数据字段**: 开盘价、收盘价、最高价、最低价、成交量、成交额、涨跌幅、换手率、振幅

---

## 使用步骤

### 第一步：数据初始化

首次使用需要同步历史数据：

1. 访问 `/sync` 页面
2. 点击"同步历史数据"按钮
3. 输入天数（建议90天）
4. 等待同步完成（约需30-60分钟）

**注意**：
- 同步过程较慢，请耐心等待
- 可以在同步日志中查看进度
- 同步期间可以关闭页面，后台会继续执行

### 第二步：查询数据

1. 访问 `/query` 页面
2. 设置查询条件：
   - **开始日期**: 查询起始日期
   - **结束日期**: 查询结束日期
   - **最小涨跌幅**: 可选，例如 `5` 表示涨幅≥5%，`-5` 表示跌幅≥5%
   - **最大涨跌幅**: 可选，例如 `10` 表示涨幅≤10%
   - **排序方式**: 降序（高到低）或升序（低到高）
   - **每页数量**: 20/50/100/200
3. 点击"开始查询"
4. 查看结果并翻页

---

## 查询示例

### 示例1：查找大涨股票

**需求**: 查找最近30天内，单日涨幅≥7%的股票

**设置**:
- 开始日期: 2025-09-16
- 结束日期: 2025-10-16
- 最小涨跌幅: `7`
- 最大涨跌幅: 留空
- 排序方式: 降序

**结果**: 显示所有单日涨幅≥7%的股票，按涨幅从高到低排序

---

### 示例2：查找大跌股票

**需求**: 查找最近7天内，单日跌幅≥5%的股票

**设置**:
- 开始日期: 2025-10-09
- 结束日期: 2025-10-16
- 最小涨跌幅: 留空
- 最大涨跌幅: `-5`
- 排序方式: 升序

**结果**: 显示所有单日跌幅≥5%的股票，按跌幅从低到高排序

---

### 示例3：查找温和上涨股票

**需求**: 查找最近30天内，单日涨幅在2%-5%之间的股票

**设置**:
- 开始日期: 2025-09-16
- 结束日期: 2025-10-16
- 最小涨跌幅: `2`
- 最大涨跌幅: `5`
- 排序方式: 降序

**结果**: 显示所有单日涨幅在2%-5%之间的股票

---

## 数据字段说明

| 字段 | 说明 | 示例 |
|------|------|------|
| 日期 | 交易日期 | 2025-10-16 |
| 股票代码 | 6位数字代码 | 000001 |
| 股票名称 | 股票简称 | 平安银行 |
| 收盘价 | 当日收盘价 | 12.50 |
| 涨跌幅 | 相对前一日的涨跌幅 | +5.23% |
| 成交量 | 成交量（手） | 1.2亿 |
| 成交额 | 成交金额（元） | 15.6亿 |
| 振幅 | (最高价-最低价)/前收盘价 | 8.5% |

---

## 定时任务说明

### 自动同步机制

1. **触发时间**: 每晚22点
2. **执行逻辑**:
   - 判断当天是否为交易日
   - 是交易日：同步当日数据
   - 非交易日：跳过同步
3. **失败重试**:
   - 如果同步失败，每小时自动重试
   - 直到成功或第二天重新开始

### 交易日判断

系统会自动判断以下情况：
- ✅ 周一至周五（工作日）
- ❌ 周六、周日（周末）
- ❌ 法定节假日（春节、国庆等）

---

## 技术架构

### 后端 API

**基础路径**: `/api/v1/daily`

**主要端点**:

1. **POST /query** - 查询数据
   ```json
   {
     "start_date": "2025-10-01",
     "end_date": "2025-10-16",
     "change_pct_min": 5,
     "change_pct_max": 10,
     "sort_by": "change_pct",
     "sort_order": "desc",
     "page": 1,
     "page_size": 50
   }
   ```

2. **GET /stock/{code}** - 获取单只股票历史
   ```
   /api/v1/daily/stock/000001?limit=60
   ```

3. **POST /sync** - 手动触发同步
   ```json
   {
     "sync_date": "2025-10-16",  // 可选
     "days": 90                   // 可选，用于初始化
   }
   ```

4. **GET /sync/status** - 获取同步状态
   ```
   /api/v1/daily/sync/status?limit=10
   ```

5. **GET /stats** - 获取数据统计
   ```
   /api/v1/daily/stats
   ```

### 数据库表

**daily_stock_data** - 每日股票数据表
```sql
- stock_code: 股票代码
- stock_name: 股票名称
- trade_date: 交易日期
- open_price: 开盘价
- close_price: 收盘价
- high_price: 最高价
- low_price: 最低价
- volume: 成交量
- amount: 成交额
- change_pct: 涨跌幅
- turnover_rate: 换手率
- amplitude: 振幅
```

**sync_logs** - 同步日志表
```sql
- sync_date: 同步日期
- sync_type: 同步类型（initial/daily）
- status: 状态（pending/running/success/failed）
- total_stocks: 总股票数
- success_count: 成功数量
- failed_count: 失败数量
```

---

## 常见问题

### Q1: 为什么查询结果为空？

**可能原因**:
1. 数据尚未同步 → 先执行数据初始化
2. 日期范围内无交易日 → 检查日期是否为周末或节假日
3. 筛选条件过于严格 → 放宽涨跌幅范围

### Q2: 同步速度很慢怎么办？

**原因**: 全市场约5000只股票，每只股票需要单独请求数据

**建议**:
- 首次同步选择较短时间范围（如30天）
- 后续通过每日自动同步逐步补充
- 同步期间可以关闭页面，后台继续执行

### Q3: 如何查看某只股票的历史走势？

**方法1**: 在查询结果中筛选
- 在浏览器中按 Ctrl+F 搜索股票代码或名称

**方法2**: 使用API直接查询
```
GET /api/v1/daily/stock/000001?limit=60
```

### Q4: 数据更新频率是多少？

- **自动同步**: 每晚22点
- **手动同步**: 随时可触发
- **数据延迟**: 通常为T+0（当日数据当晚可获取）

---

## 性能优化建议

### 查询优化

1. **缩小日期范围**: 查询时间跨度越小，速度越快
2. **使用分页**: 避免一次性加载过多数据
3. **添加筛选条件**: 涨跌幅筛选可以大幅减少结果数量

### 同步优化

1. **避免重复同步**: 系统会自动去重，无需担心
2. **错峰同步**: 手动同步建议在非高峰时段
3. **分批初始化**: 首次同步可以分多次完成

---

## 未来规划

### 近期计划
- [ ] 添加数据导出功能（Excel/CSV）
- [ ] 支持更多筛选条件（成交量、换手率等）
- [ ] 添加股票详情页（K线图）
- [ ] 支持自定义排序字段

### 长期计划
- [ ] 支持板块分类查询
- [ ] 添加技术指标计算
- [ ] 支持多维度数据分析
- [ ] 添加数据可视化图表

---

## 技术支持

如有问题或建议，请通过以下方式联系：

- **GitHub Issues**: [项目地址]
- **文档**: `/docs` 目录
- **API文档**: `http://localhost:8000/docs`

---

**最后更新**: 2025-10-16  
**版本**: v1.0
