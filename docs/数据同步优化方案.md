# ğŸ“ˆ Neon æ•°æ®åŒæ­¥ä¼˜åŒ–æ–¹æ¡ˆ

## ä¸€ã€å­˜é‡æ•°æ®åˆå§‹åŒ–ä¼˜åŒ–

### å½“å‰æ–¹æ¡ˆé—®é¢˜
1. **ä¸²è¡Œè·å–æ•°æ®**ï¼šbaostock ä¸æ”¯æŒå¤šçº¿ç¨‹ï¼Œå¿…é¡»ä¸²è¡Œ
2. **ç½‘ç»œå»¶è¿Ÿ**ï¼šæ¯æ¬¡ API è°ƒç”¨éƒ½æœ‰ç½‘ç»œå¼€é”€
3. **æ‰¹é‡å¤§å°å›ºå®š**ï¼šbatch_size=500 å¯èƒ½ä¸æ˜¯æœ€ä¼˜å€¼

### ä¼˜åŒ–æ–¹æ¡ˆ 1.1ï¼šæŒ‰æœˆåˆ†æ‰¹ + å¹¶å‘æ—¥æœŸ

**æ€è·¯**ï¼šè™½ç„¶å•ä¸ªæ—¥æœŸçš„è‚¡ç¥¨å¿…é¡»ä¸²è¡Œè·å–ï¼Œä½†å¯ä»¥å¹¶å‘å¤„ç†å¤šä¸ªæ—¥æœŸ

```python
from concurrent.futures import ThreadPoolExecutor, as_completed
from datetime import date, timedelta

def sync_historical_data_optimized(days: int = 365):
    """
    ä¼˜åŒ–çš„å†å²æ•°æ®åŒæ­¥
    - æŒ‰æœˆåˆ†æ‰¹
    - æ¯æœˆæ•°æ®å¹¶å‘å¤„ç†
    """
    # è·å–äº¤æ˜“æ—¥åˆ—è¡¨
    trading_days = get_trading_days(days)
    
    # æŒ‰æœˆåˆ†ç»„
    months = group_by_month(trading_days)
    
    for month, dates in months.items():
        print(f"åŒæ­¥ {month} çš„æ•°æ®...")
        
        # å¹¶å‘å¤„ç†è¯¥æœˆçš„å¤šä¸ªæ—¥æœŸ
        with ThreadPoolExecutor(max_workers=3) as executor:
            futures = {
                executor.submit(sync_single_day, date): date 
                for date in dates
            }
            
            for future in as_completed(futures):
                date = futures[future]
                try:
                    result = future.result()
                    print(f"{date} å®Œæˆ: {result['success']} æ¡")
                except Exception as e:
                    print(f"{date} å¤±è´¥: {e}")
```

**é¢„æœŸæ•ˆæœ**ï¼š
- 3ä¸ªæ—¥æœŸå¹¶å‘ï¼šè€—æ—¶å‡å°‘ 60-70%
- ä» 100å°æ—¶ â†’ **30-40å°æ—¶**

---

### ä¼˜åŒ–æ–¹æ¡ˆ 1.2ï¼šå¢é‡ + æ–­ç‚¹ç»­ä¼ 

**æ€è·¯**ï¼šæ”¯æŒä¸­æ–­åç»§ç»­ï¼Œé¿å…é‡å¤å·¥ä½œ

```python
import json
from pathlib import Path

class IncrementalSync:
    """å¢é‡åŒæ­¥å™¨"""
    
    def __init__(self, checkpoint_file='sync_checkpoint.json'):
        self.checkpoint_file = Path(checkpoint_file)
        self.checkpoint = self.load_checkpoint()
    
    def load_checkpoint(self):
        """åŠ è½½æ£€æŸ¥ç‚¹"""
        if self.checkpoint_file.exists():
            return json.loads(self.checkpoint_file.read_text())
        return {'completed_dates': [], 'failed_dates': []}
    
    def save_checkpoint(self):
        """ä¿å­˜æ£€æŸ¥ç‚¹"""
        self.checkpoint_file.write_text(json.dumps(self.checkpoint, indent=2))
    
    def sync_with_resume(self, trading_days):
        """æ”¯æŒæ–­ç‚¹ç»­ä¼ çš„åŒæ­¥"""
        completed = set(self.checkpoint['completed_dates'])
        remaining = [d for d in trading_days if d not in completed]
        
        print(f"æ€»å…± {len(trading_days)} å¤©ï¼Œå·²å®Œæˆ {len(completed)} å¤©")
        print(f"å‰©ä½™ {len(remaining)} å¤©")
        
        for date in remaining:
            try:
                result = sync_single_day(date)
                self.checkpoint['completed_dates'].append(date)
                self.save_checkpoint()
                print(f"âœ… {date} å®Œæˆ")
            except Exception as e:
                self.checkpoint['failed_dates'].append(date)
                self.save_checkpoint()
                print(f"âŒ {date} å¤±è´¥: {e}")
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æ”¯æŒä¸­æ–­æ¢å¤
- é¿å…é‡å¤å·¥ä½œ
- æé«˜å¯é æ€§

---

### ä¼˜åŒ–æ–¹æ¡ˆ 1.3ï¼šæ™ºèƒ½æ‰¹é‡å¤§å°

**æ€è·¯**ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´ batch_size

```python
class AdaptiveBatchSync:
    """è‡ªé€‚åº”æ‰¹é‡åŒæ­¥"""
    
    def __init__(self):
        self.batch_size = 500
        self.min_batch = 100
        self.max_batch = 1000
        self.success_rate = 1.0
    
    def adjust_batch_size(self, success_count, total_count):
        """æ ¹æ®æˆåŠŸç‡è°ƒæ•´æ‰¹é‡å¤§å°"""
        self.success_rate = success_count / total_count if total_count > 0 else 1.0
        
        if self.success_rate > 0.95:
            # æˆåŠŸç‡é«˜ï¼Œå¢åŠ æ‰¹é‡
            self.batch_size = min(self.batch_size + 100, self.max_batch)
        elif self.success_rate < 0.85:
            # æˆåŠŸç‡ä½ï¼Œå‡å°‘æ‰¹é‡
            self.batch_size = max(self.batch_size - 100, self.min_batch)
        
        return self.batch_size
    
    def sync_with_adaptive_batch(self, stocks, date_str):
        """è‡ªé€‚åº”æ‰¹é‡åŒæ­¥"""
        total_stocks = len(stocks)
        success_count = 0
        
        for i in range(0, total_stocks, self.batch_size):
            batch = stocks[i:i + self.batch_size]
            batch_success = sync_batch(batch, date_str)
            success_count += batch_success
            
            # åŠ¨æ€è°ƒæ•´
            new_batch_size = self.adjust_batch_size(batch_success, len(batch))
            print(f"æ‰¹é‡å¤§å°è°ƒæ•´: {self.batch_size} â†’ {new_batch_size}")
```

**é¢„æœŸæ•ˆæœ**ï¼š
- ç½‘ç»œå¥½æ—¶ï¼šæ›´å¤§æ‰¹é‡ï¼Œæ›´å¿«é€Ÿåº¦
- ç½‘ç»œå·®æ—¶ï¼šæ›´å°æ‰¹é‡ï¼Œæ›´ç¨³å®š
- è‡ªåŠ¨ä¼˜åŒ–ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒæ•´

---

## äºŒã€å¢é‡æ•°æ®åŒæ­¥ä¼˜åŒ–

### å½“å‰æ–¹æ¡ˆé—®é¢˜
1. **å›ºå®šæ—¶é—´æ‰§è¡Œ**ï¼šæ¯å¤©22ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æœ€ä¼˜æ—¶é—´
2. **æ— é‡è¯•æœºåˆ¶**ï¼šå¤±è´¥åéœ€è¦æ‰‹åŠ¨é‡è¯•
3. **æ— ç›‘æ§å‘Šè­¦**ï¼šåŒæ­¥å¤±è´¥ä¸çŸ¥é“

### ä¼˜åŒ–æ–¹æ¡ˆ 2.1ï¼šæ™ºèƒ½è°ƒåº¦

**æ€è·¯**ï¼šæ ¹æ®æ•°æ®å¯ç”¨æ€§æ™ºèƒ½é€‰æ‹©æ‰§è¡Œæ—¶é—´

```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger

class SmartScheduler:
    """æ™ºèƒ½è°ƒåº¦å™¨"""
    
    def __init__(self):
        self.scheduler = AsyncIOScheduler()
    
    def setup_smart_schedule(self):
        """è®¾ç½®æ™ºèƒ½è°ƒåº¦"""
        
        # æ–¹æ¡ˆ1: å¤šæ¬¡å°è¯•
        # æ™šä¸Š8ç‚¹é¦–æ¬¡å°è¯•
        self.scheduler.add_job(
            self.try_sync,
            CronTrigger(hour=20, minute=0),
            id='sync_attempt_1'
        )
        
        # æ™šä¸Š10ç‚¹äºŒæ¬¡å°è¯•
        self.scheduler.add_job(
            self.try_sync,
            CronTrigger(hour=22, minute=0),
            id='sync_attempt_2'
        )
        
        # æ—©ä¸Š8ç‚¹æœ€åå°è¯•
        self.scheduler.add_job(
            self.try_sync,
            CronTrigger(hour=8, minute=0),
            id='sync_attempt_3'
        )
    
    async def try_sync(self):
        """å°è¯•åŒæ­¥"""
        yesterday = date.today() - timedelta(days=1)
        
        # æ£€æŸ¥æ˜¯å¦å·²åŒæ­¥
        if await self.is_synced(yesterday):
            print(f"{yesterday} å·²åŒæ­¥ï¼Œè·³è¿‡")
            return
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºäº¤æ˜“æ—¥
        if not await self.is_trading_day(yesterday):
            print(f"{yesterday} éäº¤æ˜“æ—¥ï¼Œè·³è¿‡")
            return
        
        # æ‰§è¡ŒåŒæ­¥
        result = await self.sync_daily_data(yesterday)
        
        if result['status'] == 'success':
            print(f"âœ… {yesterday} åŒæ­¥æˆåŠŸ")
            # å–æ¶ˆåç»­å°è¯•
            self.cancel_remaining_attempts()
        else:
            print(f"âš ï¸ {yesterday} åŒæ­¥å¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡å°è¯•")
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æé«˜æˆåŠŸç‡ï¼ˆå¤šæ¬¡å°è¯•ï¼‰
- è‡ªåŠ¨è·³è¿‡å·²åŒæ­¥æ—¥æœŸ
- å‡å°‘äººå·¥å¹²é¢„

---

### ä¼˜åŒ–æ–¹æ¡ˆ 2.2ï¼šå¤±è´¥é‡è¯•æœºåˆ¶

**æ€è·¯**ï¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„è‚¡ç¥¨

```python
from tenacity import retry, stop_after_attempt, wait_exponential

class RetryableSync:
    """æ”¯æŒé‡è¯•çš„åŒæ­¥"""
    
    @retry(
        stop=stop_after_attempt(3),
        wait=wait_exponential(multiplier=1, min=4, max=10)
    )
    def fetch_stock_with_retry(self, stock, date_str):
        """å¸¦é‡è¯•çš„è‚¡ç¥¨æ•°æ®è·å–"""
        return self.fetch_stock_daily_data(stock, date_str)
    
    def sync_with_retry(self, stocks, date_str):
        """æ”¯æŒé‡è¯•çš„åŒæ­¥"""
        failed_stocks = []
        
        # ç¬¬ä¸€è½®ï¼šæ­£å¸¸åŒæ­¥
        for stock in stocks:
            try:
                data = self.fetch_stock_with_retry(stock, date_str)
                self.insert_data(data)
            except Exception as e:
                failed_stocks.append(stock)
                print(f"âŒ {stock['code']} å¤±è´¥: {e}")
        
        # ç¬¬äºŒè½®ï¼šé‡è¯•å¤±è´¥çš„
        if failed_stocks:
            print(f"\né‡è¯• {len(failed_stocks)} åªå¤±è´¥çš„è‚¡ç¥¨...")
            time.sleep(5)  # ç­‰å¾…5ç§’
            
            for stock in failed_stocks:
                try:
                    data = self.fetch_stock_with_retry(stock, date_str)
                    self.insert_data(data)
                    print(f"âœ… {stock['code']} é‡è¯•æˆåŠŸ")
                except Exception as e:
                    print(f"âŒ {stock['code']} é‡è¯•ä»å¤±è´¥: {e}")
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æé«˜æˆåŠŸç‡ï¼ˆä» 95% â†’ 99%+ï¼‰
- è‡ªåŠ¨å¤„ç†ä¸´æ—¶ç½‘ç»œé—®é¢˜
- å‡å°‘æ•°æ®ç¼ºå¤±

---

### ä¼˜åŒ–æ–¹æ¡ˆ 2.3ï¼šç›‘æ§å’Œå‘Šè­¦

**æ€è·¯**ï¼šå®æ—¶ç›‘æ§åŒæ­¥çŠ¶æ€ï¼Œå¤±è´¥æ—¶å‘é€é€šçŸ¥

```python
import smtplib
from email.mime.text import MIMEText

class SyncMonitor:
    """åŒæ­¥ç›‘æ§å™¨"""
    
    def __init__(self):
        self.metrics = {
            'total_syncs': 0,
            'success_syncs': 0,
            'failed_syncs': 0,
            'avg_duration': 0
        }
    
    def record_sync(self, result):
        """è®°å½•åŒæ­¥ç»“æœ"""
        self.metrics['total_syncs'] += 1
        
        if result['status'] == 'success':
            self.metrics['success_syncs'] += 1
        else:
            self.metrics['failed_syncs'] += 1
            # å‘é€å‘Šè­¦
            self.send_alert(result)
        
        # æ›´æ–°å¹³å‡è€—æ—¶
        duration = result.get('duration', 0)
        self.metrics['avg_duration'] = (
            (self.metrics['avg_duration'] * (self.metrics['total_syncs'] - 1) + duration)
            / self.metrics['total_syncs']
        )
    
    def send_alert(self, result):
        """å‘é€å‘Šè­¦"""
        message = f"""
        âš ï¸ æ•°æ®åŒæ­¥å¤±è´¥
        
        æ—¥æœŸ: {result['date']}
        é”™è¯¯: {result.get('error', 'Unknown')}
        æˆåŠŸ: {result.get('success', 0)}
        å¤±è´¥: {result.get('failed', 0)}
        
        è¯·æ£€æŸ¥æ—¥å¿—: /var/log/stockguru/sync.log
        """
        
        # å‘é€é‚®ä»¶/ä¼ä¸šå¾®ä¿¡/é’‰é’‰ç­‰
        self.send_notification(message)
    
    def get_health_status(self):
        """è·å–å¥åº·çŠ¶æ€"""
        success_rate = (
            self.metrics['success_syncs'] / self.metrics['total_syncs']
            if self.metrics['total_syncs'] > 0 else 1.0
        )
        
        return {
            'status': 'healthy' if success_rate > 0.95 else 'warning',
            'success_rate': f"{success_rate * 100:.2f}%",
            'avg_duration': f"{self.metrics['avg_duration']:.2f}s",
            'total_syncs': self.metrics['total_syncs']
        }
```

**é¢„æœŸæ•ˆæœ**ï¼š
- åŠæ—¶å‘ç°é—®é¢˜
- è‡ªåŠ¨å‘Šè­¦é€šçŸ¥
- æ•°æ®å¯è§†åŒ–ç›‘æ§

---

## ä¸‰ã€é€šç”¨ä¼˜åŒ–

### 3.1 è¿æ¥æ± ä¼˜åŒ–

**å½“å‰é—®é¢˜**ï¼šæ¯æ¬¡åŒæ­¥éƒ½åˆ›å»ºæ–°è¿æ¥

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šä½¿ç”¨è¿æ¥æ± 

```python
from psycopg2 import pool

class ConnectionPoolManager:
    """è¿æ¥æ± ç®¡ç†å™¨"""
    
    def __init__(self, database_url, min_conn=2, max_conn=10):
        self.pool = pool.ThreadedConnectionPool(
            min_conn,
            max_conn,
            database_url
        )
    
    def get_connection(self):
        """è·å–è¿æ¥"""
        return self.pool.getconn()
    
    def return_connection(self, conn):
        """å½’è¿˜è¿æ¥"""
        self.pool.putconn(conn)
    
    def close_all(self):
        """å…³é—­æ‰€æœ‰è¿æ¥"""
        self.pool.closeall()

# ä½¿ç”¨ç¤ºä¾‹
pool_manager = ConnectionPoolManager(DATABASE_URL)

def sync_with_pool(data):
    conn = pool_manager.get_connection()
    try:
        # æ‰§è¡ŒåŒæ­¥
        cursor = conn.cursor()
        execute_values(cursor, sql, data)
        conn.commit()
    finally:
        pool_manager.return_connection(conn)
```

**é¢„æœŸæ•ˆæœ**ï¼š
- å‡å°‘è¿æ¥å¼€é”€
- æé«˜å¹¶å‘æ€§èƒ½
- æ›´ç¨³å®šçš„è¿æ¥

---

### 3.2 æ•°æ®å‹ç¼©

**æ€è·¯**ï¼šå‡å°‘ç½‘ç»œä¼ è¾“é‡

```python
import gzip
import pickle

def compress_data(data):
    """å‹ç¼©æ•°æ®"""
    pickled = pickle.dumps(data)
    compressed = gzip.compress(pickled)
    return compressed

def decompress_data(compressed):
    """è§£å‹æ•°æ®"""
    pickled = gzip.decompress(compressed)
    data = pickle.loads(pickled)
    return data
```

**é¢„æœŸæ•ˆæœ**ï¼š
- å‡å°‘ 60-70% ä¼ è¾“é‡
- åŠ å¿«ç½‘ç»œä¼ è¾“
- é™ä½å¸¦å®½æˆæœ¬

---

### 3.3 å¢é‡æ›´æ–°ç­–ç•¥

**æ€è·¯**ï¼šåªæ›´æ–°å˜åŒ–çš„æ•°æ®

```python
def incremental_update(new_data, date_str):
    """å¢é‡æ›´æ–°"""
    conn = get_connection()
    cursor = conn.cursor()
    
    # 1. æŸ¥è¯¢å·²å­˜åœ¨çš„æ•°æ®
    cursor.execute("""
        SELECT stock_code, close_price, volume
        FROM daily_stock_data
        WHERE trade_date = %s
    """, (date_str,))
    
    existing = {row[0]: row for row in cursor.fetchall()}
    
    # 2. æ‰¾å‡ºéœ€è¦æ›´æ–°çš„æ•°æ®
    to_insert = []
    to_update = []
    
    for record in new_data:
        code = record['stock_code']
        if code not in existing:
            to_insert.append(record)
        elif has_changed(record, existing[code]):
            to_update.append(record)
    
    # 3. æ‰¹é‡æ’å…¥å’Œæ›´æ–°
    if to_insert:
        execute_values(cursor, insert_sql, to_insert)
    
    if to_update:
        execute_values(cursor, update_sql, to_update)
    
    conn.commit()
    
    print(f"æ–°å¢: {len(to_insert)}, æ›´æ–°: {len(to_update)}")
```

**é¢„æœŸæ•ˆæœ**ï¼š
- å‡å°‘ä¸å¿…è¦çš„å†™å…¥
- æé«˜æ›´æ–°é€Ÿåº¦
- é™ä½æ•°æ®åº“è´Ÿè½½

---

## å››ã€æ¨èå®æ–½é¡ºåº

### é˜¶æ®µ 1ï¼šç«‹å³å®æ–½ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
1. âœ… **å¤±è´¥é‡è¯•æœºåˆ¶**ï¼ˆæ–¹æ¡ˆ 2.2ï¼‰
   - å®æ–½éš¾åº¦ï¼šä½
   - æ•ˆæœï¼šæ˜¾è‘—æé«˜æˆåŠŸç‡

2. âœ… **ç›‘æ§å‘Šè­¦**ï¼ˆæ–¹æ¡ˆ 2.3ï¼‰
   - å®æ–½éš¾åº¦ï¼šä¸­
   - æ•ˆæœï¼šåŠæ—¶å‘ç°é—®é¢˜

3. âœ… **è¿æ¥æ± ä¼˜åŒ–**ï¼ˆæ–¹æ¡ˆ 3.1ï¼‰
   - å®æ–½éš¾åº¦ï¼šä½
   - æ•ˆæœï¼šæå‡æ€§èƒ½

### é˜¶æ®µ 2ï¼šçŸ­æœŸå®æ–½ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
4. â³ **æ™ºèƒ½è°ƒåº¦**ï¼ˆæ–¹æ¡ˆ 2.1ï¼‰
   - å®æ–½éš¾åº¦ï¼šä¸­
   - æ•ˆæœï¼šæé«˜å¯é æ€§

5. â³ **æ–­ç‚¹ç»­ä¼ **ï¼ˆæ–¹æ¡ˆ 1.2ï¼‰
   - å®æ–½éš¾åº¦ï¼šä¸­
   - æ•ˆæœï¼šæ”¯æŒä¸­æ–­æ¢å¤

### é˜¶æ®µ 3ï¼šé•¿æœŸä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
6. ğŸ“… **æŒ‰æœˆå¹¶å‘**ï¼ˆæ–¹æ¡ˆ 1.1ï¼‰
   - å®æ–½éš¾åº¦ï¼šé«˜
   - æ•ˆæœï¼šå¤§å¹…æå‡åˆå§‹åŒ–é€Ÿåº¦

7. ğŸ“… **è‡ªé€‚åº”æ‰¹é‡**ï¼ˆæ–¹æ¡ˆ 1.3ï¼‰
   - å®æ–½éš¾åº¦ï¼šä¸­
   - æ•ˆæœï¼šè‡ªåŠ¨ä¼˜åŒ–æ€§èƒ½

---

## äº”ã€é¢„æœŸæ•ˆæœæ€»ç»“

| ä¼˜åŒ–é¡¹ | å½“å‰æ€§èƒ½ | ä¼˜åŒ–å | æå‡ |
|--------|---------|--------|------|
| **å­˜é‡åˆå§‹åŒ–** | 100å°æ—¶ | 30-40å°æ—¶ | 2.5-3x |
| **å¢é‡åŒæ­¥** | 14åˆ†é’Ÿ | 10-12åˆ†é’Ÿ | 1.2-1.4x |
| **æˆåŠŸç‡** | 95% | 99%+ | +4% |
| **å¯é æ€§** | ä¸­ | é«˜ | â­â­â­ |
| **å¯ç»´æŠ¤æ€§** | ä¸­ | é«˜ | â­â­â­ |

---

## å…­ã€å®æ–½å»ºè®®

### æœ€å°å¯è¡Œæ–¹æ¡ˆï¼ˆMVPï¼‰
1. å¤±è´¥é‡è¯•æœºåˆ¶
2. åŸºç¡€ç›‘æ§æ—¥å¿—
3. è¿æ¥æ± ä¼˜åŒ–

**é¢„è®¡å·¥ä½œé‡**: 2-3 å¤©  
**é¢„æœŸæ”¶ç›Š**: æˆåŠŸç‡ +4%, æ€§èƒ½ +20%

### å®Œæ•´æ–¹æ¡ˆ
å®æ–½æ‰€æœ‰ä¼˜åŒ–

**é¢„è®¡å·¥ä½œé‡**: 1-2 å‘¨  
**é¢„æœŸæ”¶ç›Š**: æ€§èƒ½æå‡ 2-3å€ï¼Œå¯é æ€§å¤§å¹…æå‡

---

**å»ºè®®**: å…ˆå®æ–½é˜¶æ®µ1çš„é«˜ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ŒéªŒè¯æ•ˆæœåå†è€ƒè™‘åç»­ä¼˜åŒ–ã€‚
