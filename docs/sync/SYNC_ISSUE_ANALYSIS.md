# æ•°æ®åŒæ­¥é—®é¢˜æ·±åº¦åˆ†ææŠ¥å‘Š

## ğŸ“Š é—®é¢˜æ¦‚è¿°

**æ—¶é—´èŒƒå›´**: 2025-09-08 è‡³ 2025-09-10  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜å±

### æ ¸å¿ƒé—®é¢˜

| æ—¥æœŸ | çŠ¶æ€ | æ€»æ•° | æˆåŠŸ | å¤±è´¥ | å¤±è´¥ç‡ | å®é™…æ•°æ® | é—®é¢˜ |
|------|------|------|------|------|--------|----------|------|
| 2025-09-08 | success | 5372 | 4769 | 0 | 0% | 5269 | âš ï¸ æˆåŠŸæ•°ä¸å®é™…ä¸ç¬¦ (+500) |
| 2025-09-09 | failed | 5372 | 18 | 5354 | **99.7%** | 18 | ğŸ”´ å‡ ä¹å®Œå…¨å¤±è´¥ |
| 2025-09-10 | failed | 5373 | 3135 | 2238 | **41.7%** | 3032 | ğŸ”´ å¤§é‡å¤±è´¥ |

## ğŸ” é—®é¢˜åˆ†æ

### 1. æ ¸å¿ƒé—®é¢˜ï¼šè®¡æ•°é€»è¾‘é”™è¯¯

**å‘ç°çš„å¼‚å¸¸**ï¼š
- âœ… 2025-09-08: æˆåŠŸæ•° 4769ï¼Œä½†æ•°æ®åº“æœ‰ 5269 æ¡ï¼ˆå¤šäº† 500 æ¡ï¼‰
- âŒ 2025-09-09: æˆåŠŸæ•° 18ï¼Œå¤±è´¥æ•° 5354ï¼Œä½†å®é™…åªæœ‰ 18 æ¡æ•°æ®
- âš ï¸ 2025-09-10: æˆåŠŸæ•° 3135ï¼Œä½†æ•°æ®åº“åªæœ‰ 3032 æ¡ï¼ˆå°‘äº† 103 æ¡ï¼‰

**é—®é¢˜æ ¹æº**ï¼š
```python
# å½“å‰çš„è®¡æ•°é€»è¾‘æœ‰é—®é¢˜
success_count = æˆåŠŸè·å–æ•°æ®çš„è‚¡ç¥¨æ•°
failed_count = è·å–å¤±è´¥çš„è‚¡ç¥¨æ•°
total_records = åº”è¯¥æ˜¯å®é™…æ’å…¥æ•°æ®åº“çš„è®°å½•æ•°

# ä½†å®é™…ä¸Šï¼š
# 1. success_count å¯èƒ½åŒ…å«äº†å·²å­˜åœ¨çš„æ•°æ®ï¼ˆé‡å¤å°è¯•ï¼‰
# 2. failed_count å¯èƒ½é‡å¤è®¡æ•°
# 3. total_records è®¡ç®—ä¸å‡†ç¡®
```

### 2. 2025-09-09 çš„ç¾éš¾æ€§å¤±è´¥

**ç°è±¡**ï¼š
- 5372 åªè‚¡ç¥¨ï¼ŒåªæˆåŠŸ 18 åªï¼ˆ0.3% æˆåŠŸç‡ï¼‰
- 5354 åªå¤±è´¥ï¼ˆ99.7% å¤±è´¥ç‡ï¼‰

**å¯èƒ½åŸå› **ï¼š
1. **æ•°æ®æºé—®é¢˜**ï¼šbaostock åœ¨è¯¥æ—¥æœŸå¯èƒ½æœ‰é—®é¢˜
2. **ç½‘ç»œé—®é¢˜**ï¼šå¤§é‡è¯·æ±‚è¶…æ—¶
3. **æ•°æ®åº“è¿æ¥é—®é¢˜**ï¼šè¿æ¥æ± è€—å°½æˆ–è¶…æ—¶
4. **ä»£ç é€»è¾‘é—®é¢˜**ï¼šé”™è¯¯å¤„ç†ä¸å½“å¯¼è‡´è¿é”å¤±è´¥

### 3. 2025-09-10 çš„éƒ¨åˆ†å¤±è´¥

**ç°è±¡**ï¼š
- æˆåŠŸ 3135 åªï¼ˆ58.3%ï¼‰
- å¤±è´¥ 2238 åªï¼ˆ41.7%ï¼‰

**åˆ†æ**ï¼š
- æ¯” 09-09 å¥½ï¼Œä½†ä»ç„¶å¤±è´¥ç‡è¿‡é«˜
- å¯èƒ½æ˜¯ä» 09-09 çš„é—®é¢˜ä¸­éƒ¨åˆ†æ¢å¤

### 4. æ•°æ®ä¸€è‡´æ€§é—®é¢˜

**09-08 çš„å¼‚å¸¸**ï¼š
```
åŒæ­¥è®°å½•æ˜¾ç¤ºï¼šæˆåŠŸ 4769
æ•°æ®åº“å®é™…ï¼š5269 æ¡
å·®å¼‚ï¼š+500 æ¡
```

**å¯èƒ½åŸå› **ï¼š
1. é‡å¤åŒæ­¥ä½†è®¡æ•°å™¨æ²¡æœ‰æ­£ç¡®å¤„ç†
2. å·²å­˜åœ¨çš„æ•°æ®è¢«é‡æ–°æ’å…¥ï¼ˆON CONFLICT DO NOTHINGï¼‰
3. è®¡æ•°é€»è¾‘åœ¨å¤„ç†å·²å­˜åœ¨æ•°æ®æ—¶æœ‰bug

## ğŸ› ä»£ç é—®é¢˜å®šä½

### é—®é¢˜1ï¼šè®¡æ•°é€»è¾‘æ··ä¹±

**å½“å‰ä»£ç **ï¼ˆ`test_copy_sync.py`ï¼‰ï¼š
```python
# é—®é¢˜ï¼šsuccess å’Œ failed çš„è®¡æ•°å¯èƒ½ä¸å‡†ç¡®
success = 0
failed = 0

for stock in stocks:
    try:
        data = fetch_data(stock)
        if data:
            success += 1  # âŒ å³ä½¿æ•°æ®å·²å­˜åœ¨ä¹Ÿä¼š +1
        else:
            failed += 1
    except:
        failed += 1  # âŒ å¯èƒ½é‡å¤è®¡æ•°

# æœ€ç»ˆæ›´æ–°
total_records = actual_count  # âŒ è¿™ä¸ªå€¼å¯èƒ½ä¸æ˜¯å®é™…æ’å…¥çš„æ•°é‡
success_count = success       # âŒ åŒ…å«äº†å·²å­˜åœ¨çš„æ•°æ®
failed_count = failed         # âŒ å¯èƒ½é‡å¤è®¡æ•°
```

### é—®é¢˜2ï¼šé”™è¯¯å¤„ç†ä¸å½“

```python
# å½“å‰ä»£ç å¯èƒ½åœ¨é‡åˆ°é”™è¯¯æ—¶æ²¡æœ‰æ­£ç¡®æ¢å¤
try:
    data = bs.query_history_k_data_plus(...)
except Exception as e:
    failed += 1
    # âŒ æ²¡æœ‰è®°å½•å…·ä½“é”™è¯¯
    # âŒ æ²¡æœ‰é‡è¯•æœºåˆ¶
    # âŒ å¯èƒ½å¯¼è‡´åç»­è‚¡ç¥¨ä¹Ÿå¤±è´¥
```

### é—®é¢˜3ï¼šæ•°æ®åº“æ“ä½œé—®é¢˜

```python
# ä½¿ç”¨ ON CONFLICT DO NOTHING
INSERT INTO daily_stock_data ... ON CONFLICT DO NOTHING

# é—®é¢˜ï¼š
# 1. æ— æ³•åŒºåˆ†"æ–°æ’å…¥"å’Œ"å·²å­˜åœ¨"
# 2. è®¡æ•°å™¨ä¼šæŠŠå·²å­˜åœ¨çš„ä¹Ÿç®—ä½œæˆåŠŸ
# 3. å¯¼è‡´ success_count ä¸å‡†ç¡®
```

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤è®¡æ•°é€»è¾‘

```python
def sync_with_accurate_counting(sync_date):
    """å‡†ç¡®è®¡æ•°çš„åŒæ­¥é€»è¾‘"""
    
    # åˆå§‹åŒ–è®¡æ•°å™¨
    stats = {
        'total_stocks': 0,      # æ€»è‚¡ç¥¨æ•°
        'fetch_success': 0,     # æˆåŠŸè·å–æ•°æ®
        'fetch_failed': 0,      # è·å–å¤±è´¥
        'insert_new': 0,        # æ–°æ’å…¥è®°å½•
        'insert_skip': 0,       # è·³è¿‡ï¼ˆå·²å­˜åœ¨ï¼‰
        'insert_error': 0       # æ’å…¥é”™è¯¯
    }
    
    for stock in get_all_stocks():
        stats['total_stocks'] += 1
        
        try:
            # 1. è·å–æ•°æ®
            data = fetch_stock_data(stock, sync_date)
            
            if data is None or data.empty:
                stats['fetch_failed'] += 1
                continue
            
            stats['fetch_success'] += 1
            
            # 2. æ’å…¥æ•°æ®åº“ï¼ˆè¿”å›å®é™…æ’å…¥çš„è¡Œæ•°ï¼‰
            inserted_rows = insert_to_db(data)
            
            if inserted_rows > 0:
                stats['insert_new'] += inserted_rows
            else:
                stats['insert_skip'] += 1
                
        except Exception as e:
            stats['fetch_failed'] += 1
            log_error(stock, sync_date, str(e))
    
    # 3. æ›´æ–°åŒæ­¥çŠ¶æ€ï¼ˆä½¿ç”¨å‡†ç¡®çš„è®¡æ•°ï¼‰
    update_sync_status(
        sync_date=sync_date,
        status='success' if stats['fetch_failed'] == 0 else 'failed',
        total_records=stats['total_stocks'],
        success_count=stats['insert_new'],  # åªè®¡ç®—æ–°æ’å…¥çš„
        failed_count=stats['fetch_failed'],
        remarks=f"è·å–æˆåŠŸ{stats['fetch_success']}, å¤±è´¥{stats['fetch_failed']}, "
                f"æ–°æ’å…¥{stats['insert_new']}, å·²å­˜åœ¨{stats['insert_skip']}"
    )
```

### æ–¹æ¡ˆ2ï¼šå¢å¼ºé”™è¯¯å¤„ç†

```python
def fetch_with_retry(stock_code, sync_date, max_retries=3):
    """å¸¦é‡è¯•çš„æ•°æ®è·å–"""
    
    for attempt in range(max_retries):
        try:
            data = bs.query_history_k_data_plus(
                stock_code,
                fields="date,code,open,high,low,close,volume,amount,...",
                start_date=sync_date,
                end_date=sync_date,
                frequency="d",
                adjustflag="3"
            )
            
            if data.error_code == '0':
                return data.data
            else:
                # è®°å½• baostock è¿”å›çš„é”™è¯¯
                log_warning(f"{stock_code}: baostock error {data.error_code}")
                
        except Exception as e:
            if attempt < max_retries - 1:
                time.sleep(1)  # ç­‰å¾…åé‡è¯•
                continue
            else:
                log_error(f"{stock_code}: {str(e)}")
                return None
    
    return None
```

### æ–¹æ¡ˆ3ï¼šæ”¹è¿›æ•°æ®åº“æ’å…¥

```python
def insert_with_tracking(conn, data, sync_date):
    """è·Ÿè¸ªæ’å…¥ç»“æœçš„æ•°æ®åº“æ“ä½œ"""
    
    cur = conn.cursor()
    
    # ä½¿ç”¨ ON CONFLICT DO UPDATE æ¥è·Ÿè¸ª
    insert_sql = """
        INSERT INTO daily_stock_data (
            stock_code, stock_name, trade_date, 
            open_price, close_price, high_price, low_price,
            volume, amount, change_pct, ...
        ) VALUES %s
        ON CONFLICT (stock_code, trade_date) 
        DO UPDATE SET updated_at = NOW()
        RETURNING (xmax = 0) AS inserted
    """
    
    # æ‰¹é‡æ’å…¥å¹¶è·å–ç»“æœ
    result = execute_values(
        cur, insert_sql, data, 
        template="(%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, ...)",
        fetch=True
    )
    
    # ç»Ÿè®¡æ–°æ’å…¥å’Œæ›´æ–°çš„æ•°é‡
    new_inserts = sum(1 for row in result if row[0])
    updates = len(result) - new_inserts
    
    conn.commit()
    
    return {
        'new': new_inserts,
        'updated': updates,
        'total': len(result)
    }
```

### æ–¹æ¡ˆ4ï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—

```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    filename=f'sync_{sync_date}.log',
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

def sync_with_logging(sync_date):
    """å¸¦è¯¦ç»†æ—¥å¿—çš„åŒæ­¥"""
    
    logger = logging.getLogger(__name__)
    
    logger.info(f"å¼€å§‹åŒæ­¥ {sync_date}")
    
    for i, stock in enumerate(stocks):
        try:
            logger.debug(f"[{i+1}/{len(stocks)}] å¤„ç† {stock}")
            
            data = fetch_data(stock, sync_date)
            
            if data is None:
                logger.warning(f"{stock}: æ— æ•°æ®")
                continue
            
            result = insert_data(data)
            logger.info(f"{stock}: æ’å…¥ {result['new']} æ¡æ–°è®°å½•")
            
        except Exception as e:
            logger.error(f"{stock}: å¤±è´¥ - {str(e)}", exc_info=True)
    
    logger.info(f"åŒæ­¥å®Œæˆ {sync_date}")
```

## ğŸ”§ ä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šåœæ­¢å½“å‰åŒæ­¥ä»»åŠ¡

```bash
# é€šè¿‡ API åœæ­¢ï¼ˆå¦‚æœæœ‰åœæ­¢æ¥å£ï¼‰
# æˆ–è€…é‡å¯åç«¯æœåŠ¡
```

### æ­¥éª¤2ï¼šä¿®å¤åŒæ­¥ä»£ç 

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `scripts/test_copy_sync.py`
- `stockguru-web/backend/app/services/daily_data_sync_service_neon.py`

### æ­¥éª¤3ï¼šæ¸…ç†é”™è¯¯æ•°æ®

```sql
-- åˆ é™¤ 09-09 å’Œ 09-10 çš„é”™è¯¯æ•°æ®
DELETE FROM daily_stock_data WHERE trade_date IN ('2025-09-09', '2025-09-10');

-- é‡ç½®åŒæ­¥çŠ¶æ€
UPDATE daily_sync_status 
SET status = 'pending', 
    success_count = 0, 
    failed_count = 0,
    remarks = 'å¾…é‡æ–°åŒæ­¥ï¼ˆå·²ä¿®å¤è®¡æ•°é€»è¾‘ï¼‰'
WHERE sync_date IN ('2025-09-09', '2025-09-10');
```

### æ­¥éª¤4ï¼šé‡æ–°åŒæ­¥

```bash
# ä½¿ç”¨ä¿®å¤åçš„ä»£ç é‡æ–°åŒæ­¥
python scripts/test_copy_sync.py --date 2025-09-09
python scripts/test_copy_sync.py --date 2025-09-10
```

### æ­¥éª¤5ï¼šéªŒè¯ç»“æœ

```sql
-- éªŒè¯æ•°æ®é‡
SELECT 
    trade_date,
    COUNT(*) as records,
    COUNT(DISTINCT stock_code) as stocks
FROM daily_stock_data
WHERE trade_date BETWEEN '2025-09-08' AND '2025-09-10'
GROUP BY trade_date
ORDER BY trade_date;

-- åº”è¯¥çœ‹åˆ°æ¯å¤©çº¦ 4000-5000 æ¡è®°å½•
```

## ğŸ“‹ é¢„é˜²æªæ–½

### 1. æ·»åŠ æ•°æ®éªŒè¯

```python
def validate_sync_result(sync_date, stats):
    """éªŒè¯åŒæ­¥ç»“æœ"""
    
    warnings = []
    
    # æ£€æŸ¥æˆåŠŸç‡
    if stats['failed_count'] > stats['total_records'] * 0.1:
        warnings.append(f"å¤±è´¥ç‡è¿‡é«˜: {stats['failed_count']}/{stats['total_records']}")
    
    # æ£€æŸ¥æ•°æ®é‡
    if stats['success_count'] < 4000:
        warnings.append(f"æ•°æ®é‡åå°‘: {stats['success_count']} < 4000")
    
    # æ£€æŸ¥ä¸€è‡´æ€§
    db_count = get_db_count(sync_date)
    if abs(db_count - stats['success_count']) > 10:
        warnings.append(f"è®¡æ•°ä¸ä¸€è‡´: DB={db_count}, è®°å½•={stats['success_count']}")
    
    if warnings:
        send_alert(sync_date, warnings)
    
    return len(warnings) == 0
```

### 2. æ·»åŠ ç›‘æ§å‘Šè­¦

```python
def monitor_sync_health():
    """ç›‘æ§åŒæ­¥å¥åº·åº¦"""
    
    # æ£€æŸ¥æœ€è¿‘çš„åŒæ­¥
    recent_syncs = get_recent_syncs(days=7)
    
    for sync in recent_syncs:
        if sync['status'] == 'failed':
            alert(f"åŒæ­¥å¤±è´¥: {sync['sync_date']}")
        
        if sync['failed_count'] > sync['total_records'] * 0.1:
            alert(f"å¤±è´¥ç‡è¿‡é«˜: {sync['sync_date']}")
```

### 3. æ”¹è¿›åŒæ­¥ç­–ç•¥

```python
# åˆ†æ‰¹åŒæ­¥ï¼Œé¿å…ä¸€æ¬¡æ€§å¤„ç†å¤ªå¤š
BATCH_SIZE = 500

for batch in chunks(all_stocks, BATCH_SIZE):
    sync_batch(batch, sync_date)
    time.sleep(1)  # é¿å…è¯·æ±‚è¿‡å¿«
```

## ğŸ“Š ä¿®å¤åçš„é¢„æœŸç»“æœ

| æ—¥æœŸ | çŠ¶æ€ | æ€»æ•° | æˆåŠŸ | å¤±è´¥ | æ•°æ®åº“è®°å½• | ä¸€è‡´æ€§ |
|------|------|------|------|------|-----------|--------|
| 2025-09-09 | success | ~5373 | ~5200 | <100 | ~5200 | âœ… ä¸€è‡´ |
| 2025-09-10 | success | ~5373 | ~5200 | <100 | ~5200 | âœ… ä¸€è‡´ |

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒé—®é¢˜
1. **è®¡æ•°é€»è¾‘é”™è¯¯**ï¼šsuccess_count åŒ…å«äº†å·²å­˜åœ¨çš„æ•°æ®
2. **é”™è¯¯å¤„ç†ä¸è¶³**ï¼šå¯¼è‡´è¿é”å¤±è´¥
3. **ç¼ºä¹éªŒè¯**ï¼šæ²¡æœ‰åŠæ—¶å‘ç°å¼‚å¸¸

### è§£å†³æ–¹æ¡ˆ
1. âœ… ä¿®å¤è®¡æ•°é€»è¾‘ï¼ˆåŒºåˆ†æ–°æ’å…¥å’Œå·²å­˜åœ¨ï¼‰
2. âœ… å¢å¼ºé”™è¯¯å¤„ç†ï¼ˆé‡è¯•æœºåˆ¶ï¼‰
3. âœ… æ·»åŠ æ•°æ®éªŒè¯ï¼ˆè‡ªåŠ¨æ£€æµ‹å¼‚å¸¸ï¼‰
4. âœ… æ”¹è¿›æ—¥å¿—è®°å½•ï¼ˆä¾¿äºæ’æŸ¥ï¼‰

### ä¸‹ä¸€æ­¥
1. åœæ­¢å½“å‰åŒæ­¥ä»»åŠ¡
2. åº”ç”¨ä»£ç ä¿®å¤
3. æ¸…ç†é”™è¯¯æ•°æ®
4. é‡æ–°åŒæ­¥ 09-09 å’Œ 09-10
5. éªŒè¯ç»“æœ
