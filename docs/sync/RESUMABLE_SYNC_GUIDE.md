# æ–­ç‚¹ç»­ä¼ åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ðŸŽ‰ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå®žçŽ°å®Œæ•´çš„**æ–­ç‚¹ç»­ä¼ **åŠŸèƒ½ï¼Œæ”¯æŒï¼š
- âœ… è¿›åº¦è®°å½•å’Œè¿½è¸ª
- âœ… ä¸­æ–­åŽç»§ç»­åŒæ­¥
- âœ… å¤±è´¥è‡ªåŠ¨é‡è¯•
- âœ… å®žæ—¶è¿›åº¦æ˜¾ç¤º
- âœ… ä¸é‡å¤åŒæ­¥å·²å®Œæˆæ•°æ®

## ðŸ“¦ æ–°å¢žæ–‡ä»¶

### 1. æ•°æ®åº“ç›¸å…³
- `stockguru-web/database/sync_progress_schema.sql` - è¿›åº¦è®°å½•è¡¨ç»“æž„
- `scripts/init_sync_progress_table.py` - è¡¨åˆå§‹åŒ–è„šæœ¬

### 2. åŽç«¯æœåŠ¡
- `stockguru-web/backend/app/services/resumable_sync_service.py` - æ–­ç‚¹ç»­ä¼ åŒæ­¥æœåŠ¡
- `stockguru-web/backend/app/api/sync_progress.py` - è¿›åº¦ç®¡ç†API

### 3. å‰ç«¯é¡µé¢
- `frontend/app/sync-status/page.tsx` - å·²æ›´æ–°ï¼Œæ”¯æŒå®žæ—¶è¿›åº¦æ˜¾ç¤º

### 4. æµ‹è¯•è„šæœ¬
- `scripts/test_resumable_sync.py` - æ–­ç‚¹ç»­ä¼ åŠŸèƒ½æµ‹è¯•

## ðŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æž„

### sync_progress è¡¨

```sql
CREATE TABLE sync_progress (
    id SERIAL PRIMARY KEY,
    sync_date DATE NOT NULL,           -- åŒæ­¥æ—¥æœŸ
    stock_code VARCHAR(10) NOT NULL,   -- è‚¡ç¥¨ä»£ç 
    stock_name VARCHAR(50),            -- è‚¡ç¥¨åç§°
    status VARCHAR(20) DEFAULT 'pending',  -- pending/success/failed
    error_message TEXT,                -- é”™è¯¯ä¿¡æ¯
    retry_count INTEGER DEFAULT 0,     -- é‡è¯•æ¬¡æ•°
    synced_at TIMESTAMP,               -- åŒæ­¥å®Œæˆæ—¶é—´
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(sync_date, stock_code)
);
```

### sync_progress_summary è§†å›¾

è‡ªåŠ¨ç»Ÿè®¡æ¯æ—¥åŒæ­¥è¿›åº¦ï¼š
- æ€»è‚¡ç¥¨æ•°
- æˆåŠŸ/å¤±è´¥/å¾…åŒæ­¥æ•°é‡
- æˆåŠŸçŽ‡
- å¼€å§‹/ç»“æŸæ—¶é—´

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–æ•°æ®åº“è¡¨

```bash
cd /path/to/StockGuru
python scripts/init_sync_progress_table.py
```

### 2. å®‰è£…ä¾èµ–ï¼ˆå¦‚æžœè¿˜æ²¡å®‰è£…ï¼‰

```bash
cd stockguru-web/backend
source venv/bin/activate
pip install baostock
```

### 3. å¯åŠ¨APIæœåŠ¡

```bash
cd stockguru-web/backend
python -m uvicorn app.main:app --reload
```

### 4. è®¿é—®å‰ç«¯é¡µé¢

```
http://localhost:3000/sync-status
```

## ðŸ“¡ APIç«¯ç‚¹

### è¿›åº¦æŸ¥è¯¢

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜Ž |
|------|------|------|
| `/api/v1/sync-progress/date/{date}` | GET | èŽ·å–æŒ‡å®šæ—¥æœŸè¿›åº¦ |
| `/api/v1/sync-progress/pending/{date}` | GET | èŽ·å–å¾…åŒæ­¥è‚¡ç¥¨åˆ—è¡¨ |
| `/api/v1/sync-progress/failed/{date}` | GET | èŽ·å–å¤±è´¥è‚¡ç¥¨åˆ—è¡¨ |

### è¿›åº¦ç®¡ç†

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜Ž |
|------|------|------|
| `/api/v1/sync-progress/init/{date}` | POST | åˆå§‹åŒ–è¿›åº¦è®°å½• |
| `/api/v1/sync-progress/reset-failed/{date}` | POST | é‡ç½®å¤±è´¥ä¸ºå¾…åŒæ­¥ |
| `/api/v1/sync-progress/clear/{date}` | DELETE | æ¸…é™¤è¿›åº¦è®°å½• |

### åŒæ­¥æ‰§è¡Œ

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜Ž |
|------|------|------|
| `/api/v1/sync-progress/sync/{date}` | POST | åŽå°æ‰§è¡ŒåŒæ­¥ |
| `/api/v1/sync-progress/sync-now/{date}` | POST | ç«‹å³åŒæ­¥ï¼ˆé˜»å¡žï¼‰ |

## ðŸ’» ä½¿ç”¨ç¤ºä¾‹

### 1. Pythonä»£ç ç¤ºä¾‹

```python
from datetime import date
from app.services.resumable_sync_service import get_resumable_sync_service

sync_service = get_resumable_sync_service()
sync_date = date.today()

# æ‰§è¡Œæ–­ç‚¹ç»­ä¼ åŒæ­¥
result = sync_service.sync_with_resume(
    sync_date=sync_date,
    batch_size=50,      # æ¯æ‰¹å¤„ç†50åª
    max_retries=3       # æœ€å¤šé‡è¯•3æ¬¡
)

print(f"åŒæ­¥ç»“æžœ: {result}")
```

### 2. APIè°ƒç”¨ç¤ºä¾‹

```bash
# æŸ¥çœ‹ä»Šæ—¥è¿›åº¦
curl http://localhost:8000/api/v1/sync-progress/date/2025-10-17

# å¯åŠ¨åŒæ­¥ï¼ˆåŽå°æ‰§è¡Œï¼‰
curl -X POST http://localhost:8000/api/v1/sync-progress/sync/2025-10-17

# æŸ¥çœ‹å¾…åŒæ­¥è‚¡ç¥¨
curl http://localhost:8000/api/v1/sync-progress/pending/2025-10-17

# é‡ç½®å¤±è´¥è‚¡ç¥¨
curl -X POST http://localhost:8000/api/v1/sync-progress/reset-failed/2025-10-17
```

### 3. å‰ç«¯ä½¿ç”¨

è®¿é—® `http://localhost:3000/sync-status`ï¼Œç‚¹å‡»"åŒæ­¥ä»Šæ—¥æ•°æ®"æŒ‰é’®ï¼š

1. ç³»ç»Ÿè‡ªåŠ¨åˆå§‹åŒ–è¿›åº¦è®°å½•
2. å¼€å§‹åŽå°åŒæ­¥
3. å®žæ—¶æ˜¾ç¤ºè¿›åº¦æ¡å’Œç»Ÿè®¡
4. å¯éšæ—¶å…³é—­é¡µé¢
5. å†æ¬¡æ‰“å¼€ä¼šç»§ç»­ä¸Šæ¬¡è¿›åº¦

## ðŸŽ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. æ–­ç‚¹ç»­ä¼ 

**åœºæ™¯**: åŒæ­¥è¿‡ç¨‹ä¸­æœåŠ¡é‡å¯ã€ç½‘ç»œä¸­æ–­ç­‰

**å¤„ç†**:
1. ç³»ç»Ÿè®°å½•æ¯åªè‚¡ç¥¨çš„åŒæ­¥çŠ¶æ€
2. é‡å¯åŽè‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„è‚¡ç¥¨
3. åªåŒæ­¥æœªå®Œæˆçš„éƒ¨åˆ†
4. ä¸ä¼šé‡å¤åŒæ­¥å·²æˆåŠŸçš„æ•°æ®

**ç¤ºä¾‹**:
```
ç¬¬ä¸€æ¬¡: åŒæ­¥äº† 1000/5000 åª
ä¸­æ–­...
ç¬¬äºŒæ¬¡: ä»Žç¬¬ 1001 åªç»§ç»­ï¼Œä¸é‡å¤å‰ 1000 åª
```

### 2. å¤±è´¥é‡è¯•

**åœºæ™¯**: éƒ¨åˆ†è‚¡ç¥¨èŽ·å–å¤±è´¥ï¼ˆç½‘ç»œè¶…æ—¶ã€æ•°æ®æºé—®é¢˜ç­‰ï¼‰

**å¤„ç†**:
1. å¤±è´¥è‚¡ç¥¨æ ‡è®°ä¸º `failed`
2. è®°å½•é”™è¯¯ä¿¡æ¯å’Œé‡è¯•æ¬¡æ•°
3. å¯æ‰‹åŠ¨é‡ç½®ä¸ºå¾…åŒæ­¥
4. æ”¯æŒè®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°

**ç¤ºä¾‹**:
```python
# é‡ç½®å¤±è´¥è‚¡ç¥¨ä¸ºå¾…åŒæ­¥
sync_service.reset_failed_to_pending(sync_date)

# é‡æ–°åŒæ­¥ï¼ˆåªå¤„ç†å¤±è´¥çš„ï¼‰
sync_service.sync_with_resume(sync_date)
```

### 3. è¿›åº¦è¿½è¸ª

**å®žæ—¶æŸ¥è¯¢**:
- æ€»è‚¡ç¥¨æ•°
- æˆåŠŸæ•°é‡
- å¤±è´¥æ•°é‡
- å¾…åŒæ­¥æ•°é‡
- å®Œæˆç™¾åˆ†æ¯”

**å‰ç«¯æ˜¾ç¤º**:
- è¿›åº¦æ¡åŠ¨ç”»
- å®žæ—¶æ•°å­—æ›´æ–°
- æ¯2ç§’è‡ªåŠ¨åˆ·æ–°
- å®ŒæˆåŽè‡ªåŠ¨åœæ­¢

### 4. æ‰¹é‡å¤„ç†

**ä¼˜åŠ¿**:
- é¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šæ•°æ®
- å‡å°‘å†…å­˜å ç”¨
- æ”¯æŒåˆ†æ‰¹æäº¤
- ä¾¿äºŽè¿›åº¦æŽ§åˆ¶

**é…ç½®**:
```python
sync_service.sync_with_resume(
    sync_date=sync_date,
    batch_size=50,      # æ¯æ‰¹50åª
    max_retries=3       # æœ€å¤šé‡è¯•3æ¬¡
)
```

## ðŸ“Š æ€§èƒ½æ•°æ®

æ ¹æ®å®žé™…æµ‹è¯•ï¼ˆ4193åªAè‚¡ï¼‰ï¼š

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ€»è‚¡ç¥¨æ•° | 4193åª |
| åŒæ­¥é€Ÿåº¦ | 5-6åª/ç§’ |
| æ€»è€—æ—¶ | çº¦13-14åˆ†é’Ÿ |
| æˆåŠŸçŽ‡ | >99% |
| æ–­ç‚¹ç»­ä¼ å¼€é”€ | <1% |

**æ–­ç‚¹ç»­ä¼ ä¼˜åŠ¿**:
- âœ… ä¸­æ–­åŽæ— éœ€ä»Žå¤´å¼€å§‹
- âœ… èŠ‚çœå·²å®Œæˆéƒ¨åˆ†çš„æ—¶é—´
- âœ… é™ä½Žæ•°æ®æºåŽ‹åŠ›
- âœ… æé«˜æ•´ä½“å¯é æ€§

## ðŸ”§ æ•…éšœæŽ’æŸ¥

### é—®é¢˜1: è¿›åº¦å¡ä½ä¸åŠ¨

**åŽŸå› **: å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æ•°æ®æºé™æµ

**è§£å†³**:
```bash
# 1. æŸ¥çœ‹å¤±è´¥è‚¡ç¥¨
curl http://localhost:8000/api/v1/sync-progress/failed/2025-10-17

# 2. é‡ç½®å¤±è´¥è‚¡ç¥¨
curl -X POST http://localhost:8000/api/v1/sync-progress/reset-failed/2025-10-17

# 3. é‡æ–°åŒæ­¥
curl -X POST http://localhost:8000/api/v1/sync-progress/sync/2025-10-17
```

### é—®é¢˜2: é‡å¤åŒæ­¥

**åŽŸå› **: å¯èƒ½æ˜¯è¿›åº¦è®°å½•æœªæ­£ç¡®ä¿å­˜

**è§£å†³**:
```bash
# æ¸…é™¤è¿›åº¦è®°å½•ï¼Œé‡æ–°å¼€å§‹
curl -X DELETE http://localhost:8000/api/v1/sync-progress/clear/2025-10-17
```

### é—®é¢˜3: å‰ç«¯è¿›åº¦ä¸æ›´æ–°

**åŽŸå› **: è½®è¯¢å¯èƒ½è¢«é˜»æ­¢æˆ–APIå¼‚å¸¸

**è§£å†³**:
1. åˆ·æ–°é¡µé¢
2. æ£€æŸ¥æµè§ˆå™¨æŽ§åˆ¶å°é”™è¯¯
3. ç¡®è®¤APIæœåŠ¡æ­£å¸¸è¿è¡Œ

## ðŸ“ æœ€ä½³å®žè·µ

### 1. æ—¥å¸¸ä½¿ç”¨

```bash
# æ¯å¤©è‡ªåŠ¨åŒæ­¥ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
0 20 * * * curl -X POST http://localhost:8000/api/v1/sync-progress/sync/$(date +\%Y-\%m-\%d)
```

### 2. è¡¥å……åŽ†å²æ•°æ®

```python
from datetime import date, timedelta
from app.services.resumable_sync_service import get_resumable_sync_service

sync_service = get_resumable_sync_service()

# åŒæ­¥æœ€è¿‘30å¤©
for i in range(30):
    sync_date = date.today() - timedelta(days=i)
    print(f"åŒæ­¥ {sync_date}...")
    result = sync_service.sync_with_resume(sync_date)
    print(f"ç»“æžœ: {result}")
```

### 3. ç›‘æŽ§åŒæ­¥çŠ¶æ€

```sql
-- æŸ¥çœ‹æœ€è¿‘åŒæ­¥æƒ…å†µ
SELECT * FROM sync_progress_summary 
ORDER BY sync_date DESC 
LIMIT 10;

-- æŸ¥çœ‹å¤±è´¥çŽ‡é«˜çš„æ—¥æœŸ
SELECT sync_date, failed_count, success_rate
FROM sync_progress_summary
WHERE success_rate < 95
ORDER BY sync_date DESC;
```

## ðŸŽ¨ å‰ç«¯åŠŸèƒ½

è®¿é—® `http://localhost:3000/sync-status`

### åŠŸèƒ½åˆ—è¡¨

1. **å®žæ—¶è¿›åº¦æ˜¾ç¤º**
   - è¿›åº¦æ¡åŠ¨ç”»
   - ç™¾åˆ†æ¯”æ˜¾ç¤º
   - æˆåŠŸ/å¤±è´¥/å¾…åŒæ­¥ç»Ÿè®¡

2. **æ“ä½œæŒ‰é’®**
   - åŒæ­¥ä»Šæ—¥æ•°æ®
   - æ‰¹é‡åŒæ­¥å¾…åŒæ­¥æ—¥æœŸ
   - åˆ·æ–°çŠ¶æ€

3. **çŠ¶æ€ç»Ÿè®¡**
   - æœ€è¿‘30å¤©ç»Ÿè®¡
   - æˆåŠŸ/å¤±è´¥æ•°é‡
   - å¾…åŒæ­¥æ—¥æœŸåˆ—è¡¨

4. **åŒæ­¥è®°å½•è¡¨æ ¼**
   - æ—¥æœŸã€çŠ¶æ€ã€æ•°é‡
   - å¼€å§‹/ç»“æŸæ—¶é—´
   - è€—æ—¶ç»Ÿè®¡

## ðŸ”„ ä¸ŽåŽŸæœ‰åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | åŽŸæœ‰æ–¹å¼ | æ–­ç‚¹ç»­ä¼ æ–¹å¼ |
|------|---------|------------|
| ä¸­æ–­å¤„ç† | ä»Žå¤´å¼€å§‹ | ç»§ç»­ä¸Šæ¬¡è¿›åº¦ |
| å¤±è´¥å¤„ç† | æ•´ä½“å¤±è´¥ | å•ç‹¬é‡è¯• |
| è¿›åº¦æŸ¥è¯¢ | æ—  | å®žæ—¶æŸ¥è¯¢ |
| æ—¶é—´æˆæœ¬ | é«˜ï¼ˆé‡å¤åŒæ­¥ï¼‰ | ä½Žï¼ˆåªåŒæ­¥æœªå®Œæˆï¼‰ |
| å¯é æ€§ | ä½Ž | é«˜ |

## âœ… åŠŸèƒ½éªŒè¯

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯æ‰€æœ‰åŠŸèƒ½ï¼š

```bash
python scripts/test_resumable_sync.py
```

æµ‹è¯•å†…å®¹ï¼š
- âœ… è¿›åº¦åˆå§‹åŒ–
- âœ… è¿›åº¦æŸ¥è¯¢
- âœ… æ–­ç‚¹ç»­ä¼ ï¼ˆæ¨¡æ‹Ÿä¸­æ–­ï¼‰
- âœ… å¤±è´¥é‡è¯•
- âœ… ä¸é‡å¤åŒæ­¥

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [åŒæ­¥çŠ¶æ€ç®¡ç†æŒ‡å—](SYNC_STATUS_GUIDE.md)
- [APIæ–‡æ¡£](http://localhost:8000/docs)
- [æ•°æ®åº“Schema](stockguru-web/database/sync_progress_schema.sql)

## ðŸŽ‰ æ€»ç»“

æ–­ç‚¹ç»­ä¼ åŠŸèƒ½å·²å®Œæ•´å®žçŽ°ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… **æ•°æ®åº“å±‚**: è¿›åº¦è®°å½•è¡¨å’Œç»Ÿè®¡è§†å›¾
2. âœ… **æœåŠ¡å±‚**: å®Œæ•´çš„æ–­ç‚¹ç»­ä¼ é€»è¾‘
3. âœ… **APIå±‚**: 10+ä¸ªè¿›åº¦ç®¡ç†ç«¯ç‚¹
4. âœ… **å‰ç«¯å±‚**: å®žæ—¶è¿›åº¦æ˜¾ç¤ºå’Œæ“ä½œç•Œé¢
5. âœ… **æµ‹è¯•**: å®Œæ•´çš„åŠŸèƒ½æµ‹è¯•è„šæœ¬

**æ ¸å¿ƒä¼˜åŠ¿**:
- ðŸš€ ä¸­æ–­åŽæ— éœ€ä»Žå¤´å¼€å§‹
- ðŸ”„ è‡ªåŠ¨è·³è¿‡å·²å®Œæˆæ•°æ®
- ðŸŽ¯ å¤±è´¥å•ç‹¬é‡è¯•
- ðŸ“Š å®žæ—¶è¿›åº¦è¿½è¸ª
- ðŸ’ª æé«˜åŒæ­¥å¯é æ€§

çŽ°åœ¨å¯ä»¥æ”¾å¿ƒä½¿ç”¨ï¼Œå³ä½¿åŒæ­¥è¿‡ç¨‹ä¸­å‡ºçŽ°ä»»ä½•é—®é¢˜ï¼Œéƒ½èƒ½ä»Žä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹ç»§ç»­ï¼
