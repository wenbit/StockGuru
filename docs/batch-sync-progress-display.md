# 批量同步进度显示说明

## 📋 功能说明

批量同步进度监控面板会在**有活跃的批量同步任务时**自动显示在页面顶部。

## 🎯 显示条件

### 何时显示进度面板？

进度面板**仅在以下情况显示**：

1. ✅ 通过 Web 界面启动的批量同步任务
2. ✅ 任务状态为 `running`（运行中）
3. ✅ 前端每3秒检测到活跃任务

### 何时不显示？

进度面板**不会显示**在以下情况：

1. ❌ 没有运行中的批量同步任务
2. ❌ 通过命令行启动的同步任务
3. ❌ 任务已完成（状态为 `completed`）
4. ❌ 任务已失败（状态为 `failed`）

## 🔄 工作流程

### 1. 启动同步任务

**方式1：Web界面（推荐）**
```
1. 访问 http://localhost:3000/sync-status
2. 在"批量同步"区域选择日期范围
3. 点击"开始同步"按钮
4. 后台进度面板自动出现
```

**方式2：API调用**
```bash
curl -X POST "http://localhost:8000/api/v1/sync-status/sync/batch" \
  -H "Content-Type: application/json" \
  -d '{"start_date": "2025-10-01", "end_date": "2025-10-10"}'
```

### 2. 进度显示

任务启动后，页面会：

```
1. 前端每3秒调用 /sync/batch/active API
2. 检测到活跃任务
3. 显示蓝色渐变进度面板
4. 实时更新进度信息
```

### 3. 任务完成

任务完成后：

```
1. 任务状态变为 completed
2. 前端检测到状态变化
3. 自动隐藏进度面板
4. 刷新同步记录列表
```

## 📊 进度面板内容

### 显示信息

当有活跃任务时，进度面板显示：

```
┌─────────────────────────────────────────────────────┐
│ 🔄 后台同步进度                    [🔄刷新] 66.7%  │
│ 同步范围: 2025-10-01 至 2025-10-09                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                     │
│ 当前日期  进度  成功  失败  跳过                    │
│ 2025-10-06  6/9   5    0     1                     │
│                                                     │
│ 正在同步 2025-10-06... (66.7%)                     │
│ 预计完成: 16:25:30                                 │
└─────────────────────────────────────────────────────┘
```

### 刷新按钮

- 点击刷新按钮立即更新进度
- 图标旋转动画表示正在刷新
- 不影响自动轮询（每3秒）

## 🧪 测试方法

### 测试1：启动短期任务

```bash
# 在Web界面
1. 选择日期：今天 至 明天（2天）
2. 点击"开始同步"
3. 观察进度面板是否出现
4. 观察进度是否实时更新
```

### 测试2：启动长期任务

```bash
# 在Web界面
1. 选择日期：2025-10-01 至 2025-10-10（10天）
2. 点击"开始同步"
3. 观察进度面板
4. 点击刷新按钮测试
5. 查看预计完成时间
```

### 测试3：API调用

```bash
# 启动任务
curl -X POST "http://localhost:8000/api/v1/sync-status/sync/batch" \
  -H "Content-Type: application/json" \
  -d '{"start_date": "2025-10-01", "end_date": "2025-10-05"}'

# 查看进度
curl "http://localhost:8000/api/v1/sync-status/sync/batch/active"

# 刷新页面，应该看到进度面板
```

## ❓ 常见问题

### Q1: 为什么看不到进度面板？

**可能原因**：

1. **没有活跃任务**
   - 检查：访问 `/sync/batch/active` API
   - 解决：启动一个批量同步任务

2. **任务已完成**
   - 同步速度很快，任务可能已完成
   - 解决：选择更大的日期范围

3. **命令行启动的任务**
   - 命令行任务不会被Web界面追踪
   - 解决：使用Web界面启动

4. **前端未刷新**
   - 前端代码可能未更新
   - 解决：硬刷新页面 (Cmd+Shift+R)

### Q2: 进度面板一闪而过？

**原因**：同步任务完成太快

**解决方案**：
- 选择更大的日期范围（如10天以上）
- 或者同步未来日期（会跳过，但能看到进度）

### Q3: 进度不更新？

**可能原因**：

1. **自动轮询失败**
   - 检查浏览器控制台错误
   - 检查后端是否运行

2. **任务卡住**
   - 检查后端日志
   - 检查数据库连接

**解决方案**：
- 点击手动刷新按钮
- 重启后端服务
- 检查网络连接

### Q4: 显示的信息不完整？

**检查项**：

1. **后端数据**
   ```bash
   curl "http://localhost:8000/api/v1/sync-status/sync/batch/active"
   ```

2. **浏览器控制台**
   - 打开开发者工具 (F12)
   - 查看 Console 标签
   - 查看 Network 标签

3. **后端日志**
   ```bash
   tail -f logs/app.log | grep -i batch
   ```

## 🎨 UI 状态

### 无任务时

```
┌─────────────────────────────────────────────┐
│ 批量同步：                                    │
│ [开始日期] 至 [结束日期] [开始同步]           │
└─────────────────────────────────────────────┘
# 没有进度面板
```

### 有任务时

```
┌─────────────────────────────────────────────┐
│ 🔄 后台同步进度              66.7%         │
│ 同步范围: 2025-10-01 至 2025-10-09         │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ...进度详情...                              │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 批量同步：                                    │
│ [开始日期] 至 [结束日期] [开始同步]           │
└─────────────────────────────────────────────┘
```

## 🔧 技术实现

### 前端检测逻辑

```typescript
// 每3秒检查一次活跃任务
useEffect(() => {
  const checkBackgroundTask = async () => {
    const res = await fetch('/api/v1/sync-status/sync/batch/active');
    const data = await res.json();
    
    if (data.status === 'success' && data.data) {
      // 有活跃任务，显示进度面板
      setBackgroundProgress(data.data.progress);
      setHasBackgroundTask(true);
    } else {
      // 无活跃任务，隐藏进度面板
      setBackgroundProgress(null);
      setHasBackgroundTask(false);
    }
  };
  
  checkBackgroundTask();
  const interval = setInterval(checkBackgroundTask, 3000);
  return () => clearInterval(interval);
}, []);
```

### 后端API逻辑

```python
@router.get("/sync/batch/active")
async def get_active_batch_sync():
    """获取当前活跃的批量同步任务"""
    active_tasks = []
    for task_id, progress in _batch_sync_progress.items():
        if progress.get('status') == 'running':
            active_tasks.append({
                'task_id': task_id,
                'progress': progress
            })
    
    if active_tasks:
        return {"status": "success", "data": active_tasks[0]}
    else:
        return {"status": "success", "data": None}
```

## 📝 使用建议

### 开发环境

1. **测试进度显示**
   - 选择较大日期范围（10天以上）
   - 观察进度更新
   - 测试刷新按钮

2. **调试问题**
   - 打开浏览器开发者工具
   - 查看 Network 标签的 API 调用
   - 查看 Console 标签的错误信息

### 生产环境

1. **监控任务**
   - 定期检查活跃任务
   - 监控任务完成率
   - 记录异常情况

2. **用户提示**
   - 告知用户进度面板的显示条件
   - 提供手动刷新选项
   - 显示任务历史记录

## ✅ 验证清单

使用以下清单验证功能：

- [ ] 启动批量同步任务
- [ ] 进度面板自动出现
- [ ] 进度信息实时更新
- [ ] 刷新按钮正常工作
- [ ] 任务完成后面板消失
- [ ] 统计卡片正确显示
- [ ] 同步记录列表更新

## 🎯 总结

**关键点**：
1. 进度面板只在有活跃任务时显示
2. 必须通过Web界面启动任务
3. 前端每3秒自动检测
4. 支持手动刷新

**最佳实践**：
- 使用Web界面启动同步
- 选择合适的日期范围
- 观察进度面板显示
- 必要时手动刷新

现在你知道如何使用批量同步进度显示功能了！🎉
