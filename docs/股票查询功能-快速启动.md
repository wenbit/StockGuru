# 🚀 股票查询功能 - 快速启动指南

## 📋 前置准备

### 1. 环境要求
- Python 3.12+
- Node.js 18+
- Supabase 账号

### 2. 安装依赖

**后端**:
```bash
cd stockguru-web/backend
pip install -r requirements.txt
```

**前端**:
```bash
cd frontend
npm install
```

---

## 🗄️ 数据库设置

### 1. 在 Supabase 中执行 SQL

访问 Supabase Dashboard → SQL Editor，依次执行：

```bash
# 1. 执行基础表结构
stockguru-web/database/schema.sql

# 2. 执行股票数据表结构
stockguru-web/database/daily_stock_data_schema.sql
```

### 2. 验证表创建

确认以下表已创建：
- ✅ `daily_stock_data` - 每日股票数据表
- ✅ `sync_logs` - 同步日志表
- ✅ `tasks` - 任务表（已存在）
- ✅ `results` - 结果表（已存在）

---

## ⚙️ 配置环境变量

### 后端配置

编辑 `stockguru-web/backend/.env`:

```bash
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_anon_key
```

### 前端配置

编辑 `frontend/.env.local`:

```bash
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

---

## 🚀 启动服务

### 1. 启动后端

```bash
cd stockguru-web/backend
uvicorn app.main:app --reload --port 8000
```

**验证**:
- 访问 http://localhost:8000/docs
- 应该能看到新增的 `/api/v1/daily` 相关接口

### 2. 启动前端

```bash
cd frontend
npm run dev
```

**验证**:
- 访问 http://localhost:3000/query
- 访问 http://localhost:3000/sync

---

## 📊 初始化数据

### 方法1: 通过前端界面（推荐）

1. 访问 http://localhost:3000/sync
2. 点击"同步历史数据"按钮
3. 输入天数（建议 `90`）
4. 等待同步完成（约30-60分钟）

### 方法2: 通过 API

```bash
curl -X POST "http://localhost:8000/api/v1/daily/sync" \
  -H "Content-Type: application/json" \
  -d '{"days": 90}'
```

### 方法3: 通过 Python 脚本

创建 `init_data.py`:

```python
import asyncio
from app.services.daily_data_sync_service import get_sync_service

async def main():
    sync_service = get_sync_service()
    result = await sync_service.sync_historical_data(days=90)
    print(f"同步完成: {result}")

if __name__ == "__main__":
    asyncio.run(main())
```

运行:
```bash
cd stockguru-web/backend
python init_data.py
```

---

## ✅ 功能测试

### 1. 测试查询功能

访问 http://localhost:3000/query

**测试用例1**: 查找大涨股票
- 开始日期: 最近30天前
- 结束日期: 昨天
- 最小涨跌幅: `5`
- 点击"开始查询"

**预期结果**: 显示涨幅≥5%的股票列表

### 2. 测试同步功能

访问 http://localhost:3000/sync

**测试用例2**: 手动同步今日数据
- 点击"同步今日数据"
- 查看同步日志

**预期结果**: 
- 如果是交易日：显示同步成功
- 如果是非交易日：显示"已跳过"

### 3. 测试 API

```bash
# 获取数据统计
curl http://localhost:8000/api/v1/daily/stats

# 查询股票数据
curl -X POST "http://localhost:8000/api/v1/daily/query" \
  -H "Content-Type: application/json" \
  -d '{
    "start_date": "2025-09-16",
    "end_date": "2025-10-16",
    "change_pct_min": 5,
    "sort_by": "change_pct",
    "sort_order": "desc",
    "page": 1,
    "page_size": 20
  }'

# 获取单只股票历史
curl http://localhost:8000/api/v1/daily/stock/000001?limit=60
```

---

## 🔧 常见问题排查

### 问题1: 后端启动失败

**错误**: `ImportError: No module named 'APScheduler'`

**解决**:
```bash
pip install APScheduler==3.10.4
```

### 问题2: 数据库连接失败

**错误**: `Supabase 连接失败`

**解决**:
1. 检查 `.env` 文件中的 `SUPABASE_URL` 和 `SUPABASE_KEY`
2. 确认 Supabase 项目状态正常
3. 检查网络连接

### 问题3: 同步数据失败

**错误**: `akshare 未安装`

**解决**:
```bash
pip install akshare
```

### 问题4: 前端页面空白

**错误**: 控制台显示 CORS 错误

**解决**:
1. 确认后端已启动
2. 检查 `NEXT_PUBLIC_API_URL` 配置
3. 确认后端 CORS 配置正确

### 问题5: 定时任务未启动

**检查方法**:
```bash
# 查看后端日志
# 应该看到: "定时任务调度器已启动"
```

**解决**:
1. 确认后端正常启动
2. 检查日志中是否有错误信息
3. 手动触发同步测试

---

## 📈 性能优化建议

### 1. 数据库索引

确保以下索引已创建（已在 schema 中定义）:
- `idx_daily_stock_trade_date`
- `idx_daily_stock_code`
- `idx_daily_stock_change_pct`
- `idx_daily_stock_date_change`

### 2. 查询优化

- 缩小日期范围
- 使用涨跌幅筛选
- 合理设置分页大小

### 3. 同步优化

- 首次同步选择较短时间范围（30天）
- 使用增量同步（每日自动）
- 避免高峰时段手动同步

---

## 🎯 下一步

### 功能扩展
1. 添加数据导出功能
2. 集成 K线图展示
3. 添加更多筛选条件
4. 支持自定义指标计算

### 性能优化
1. 添加 Redis 缓存
2. 优化数据库查询
3. 实现数据预加载
4. 添加 CDN 加速

---

## 📚 相关文档

- [完整使用指南](./股票查询功能使用指南.md)
- [API 文档](http://localhost:8000/docs)
- [项目 README](../README.md)

---

## 🆘 获取帮助

如遇到问题：
1. 查看日志文件
2. 检查 API 文档
3. 提交 GitHub Issue
4. 查看常见问题

---

**祝使用愉快！** 🎉
