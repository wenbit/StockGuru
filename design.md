### **è‚¡ç¥¨çŸ­çº¿å¤ç›˜åŠ©æ‰‹ - æŠ€æœ¯è®¾è®¡æ–‡æ¡£ (TDD)**

| **æ–‡æ¡£ç‰ˆæœ¬** | **V1.0** | **åˆ›å»ºæ—¥æœŸ** | 2025å¹´10æœˆ14æ—¥ |
| :--- | :--- | :--- | :--- |
| **åˆ›å»ºäºº** | Cascade | **å…³è”æ–‡æ¡£** | prd.md |

---

## 1. æŠ€æœ¯æ¶æ„æ¦‚è§ˆ

### 1.1 æ•´ä½“æ¶æ„
æœ¬é¡¹ç›®é‡‡ç”¨**å‰åç«¯åˆ†ç¦»**çš„è®¾è®¡æ€è·¯ï¼Œä½†è¾“å‡ºä¸º**é™æ€ HTML æ–‡ä»¶**ï¼Œæ— éœ€è¿è¡Œæ—¶æœåŠ¡å™¨ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·äº¤äº’å±‚                              â”‚
â”‚                  (æµè§ˆå™¨æ‰“å¼€ HTML æ–‡ä»¶)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å±•ç¤ºå±‚                                  â”‚
â”‚          HTML (Jinja2 æ¨¡æ¿) + CSS + JavaScript               â”‚
â”‚              äº¤äº’å¼å›¾è¡¨ (Pyecharts/Plotly)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ä¸šåŠ¡é€»è¾‘å±‚                              â”‚
â”‚         æ•°æ®ç­›é€‰ + ç»¼åˆè¯„åˆ† + åŠ¨é‡è®¡ç®— (Python)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®è®¿é—®å±‚                              â”‚
â”‚            pywencai (çƒ­åº¦/æˆäº¤é¢) + akshare (è¡Œæƒ…)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯é€‰å‹

| å±‚çº§ | æŠ€æœ¯æ ˆ | ç”¨é€” | ç‰ˆæœ¬è¦æ±‚ |
| :--- | :--- | :--- | :--- |
| **è¿è¡Œç¯å¢ƒ** | Python | æ ¸å¿ƒå¼€å‘è¯­è¨€ | â‰¥ 3.8 |
| **æ•°æ®æº** | pywencai | è·å–æˆäº¤é¢æ’åã€çƒ­åº¦æ’å | latest |
| **æ•°æ®æº** | akshare | è·å–æ—¥çº¿è¡Œæƒ…ã€è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ | latest |
| **æ•°æ®å¤„ç†** | pandas | æ•°æ®æ¸…æ´—ã€ç­›é€‰ã€æ’åº | â‰¥ 1.3.0 |
| **æ•°æ®å¤„ç†** | numpy | æ•°å€¼è®¡ç®— | â‰¥ 1.20.0 |
| **æœºå™¨å­¦ä¹ ** | scikit-learn | çº¿æ€§å›å½’è®¡ç®—åŠ¨é‡ | â‰¥ 0.24.0 |
| **æ¨¡æ¿å¼•æ“** | Jinja2 | ç”Ÿæˆ HTML é¡µé¢ | â‰¥ 3.0.0 |
| **å›¾è¡¨åº“** | pyecharts | ç»˜åˆ¶ Kçº¿å›¾å’ŒæŠ€æœ¯æŒ‡æ ‡ | â‰¥ 2.0.0 |
| **æ—¥æœŸå¤„ç†** | python-dateutil | äº¤æ˜“æ—¥è®¡ç®— | â‰¥ 2.8.0 |

---

## 2. ç³»ç»Ÿæ¨¡å—è®¾è®¡

### 2.1 é¡¹ç›®ç›®å½•ç»“æ„

```
StockGuru/
â”œâ”€â”€ prd.md                      # äº§å“éœ€æ±‚æ–‡æ¡£
â”œâ”€â”€ design.md                   # æŠ€æœ¯è®¾è®¡æ–‡æ¡£ (æœ¬æ–‡ä»¶)
â”œâ”€â”€ requirements.txt            # Python ä¾èµ–æ¸…å•
â”œâ”€â”€ config.py                   # é…ç½®å‚æ•°
â”œâ”€â”€ main.py                     # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ modules/                    # æ ¸å¿ƒæ¨¡å—ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ data_fetcher.py        # æ•°æ®è·å–æ¨¡å—
â”‚   â”œâ”€â”€ stock_filter.py        # è‚¡ç¥¨ç­›é€‰æ¨¡å—
â”‚   â”œâ”€â”€ momentum_calculator.py # åŠ¨é‡è®¡ç®—æ¨¡å—
â”‚   â””â”€â”€ report_generator.py    # æŠ¥å‘Šç”Ÿæˆæ¨¡å—
â”œâ”€â”€ templates/                  # HTML æ¨¡æ¿ç›®å½•
â”‚   â””â”€â”€ report_template.html   # æŠ¥å‘Šé¡µé¢æ¨¡æ¿
â”œâ”€â”€ static/                     # é™æ€èµ„æºç›®å½•
â”‚   â””â”€â”€ style.css              # è‡ªå®šä¹‰æ ·å¼
â”œâ”€â”€ output/                     # è¾“å‡ºç›®å½•
â”‚   â””â”€â”€ report_YYYYMMDD.html   # ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶
â””â”€â”€ data/                       # æ•°æ®ç¼“å­˜ç›®å½• (å¯é€‰)
    â””â”€â”€ cache/                 # ä¸´æ—¶æ•°æ®ç¼“å­˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—è¯¦ç»†è®¾è®¡

#### 2.2.1 é…ç½®æ¨¡å— (`config.py`)

**èŒè´£**: é›†ä¸­ç®¡ç†æ‰€æœ‰å¯é…ç½®å‚æ•°

```python
# ç­›é€‰å‚æ•°
VOLUME_TOP_N = 100          # æˆäº¤é¢æ’åèŒƒå›´
HOT_TOP_N = 100             # çƒ­åº¦æ’åèŒƒå›´
FINAL_TOP_N = 30            # ç»¼åˆè¯„åˆ†å–å‰Nå
MOMENTUM_DAYS = 25          # åŠ¨é‡è®¡ç®—å‘¨æœŸ(å¤©)
MOMENTUM_TOP_N = 10         # æœ€ç»ˆç­›é€‰æ•°é‡

# ç»¼åˆè¯„åˆ†æƒé‡
WEIGHT_VOLUME = 0.5         # æˆäº¤é¢æƒé‡
WEIGHT_HOT = 0.5            # çƒ­åº¦æƒé‡

# è¿‡æ»¤è§„åˆ™
EXCLUDE_ST = True           # æ˜¯å¦æ’é™¤STè‚¡
EXCLUDE_NEW_STOCK_DAYS = 60 # æ’é™¤ä¸Šå¸‚Nå¤©å†…çš„æ¬¡æ–°è‚¡
MAX_RISE_RATIO = 1.0        # æ’é™¤Nå¤©å†…æ¶¨å¹…è¶…è¿‡100%çš„è‚¡ç¥¨

# å›¾è¡¨é…ç½®
MA_PERIODS = [5, 10, 20]    # å‡çº¿å‘¨æœŸ
CHART_WIDTH = "100%"        # å›¾è¡¨å®½åº¦
CHART_HEIGHT = "500px"      # å›¾è¡¨é«˜åº¦

# è¾“å‡ºé…ç½®
OUTPUT_DIR = "./output"     # æŠ¥å‘Šè¾“å‡ºç›®å½•
TEMPLATE_DIR = "./templates" # æ¨¡æ¿ç›®å½•
```

---

#### 2.2.2 æ•°æ®è·å–æ¨¡å— (`modules/data_fetcher.py`)

**èŒè´£**: å°è£…æ‰€æœ‰å¤–éƒ¨æ•°æ®æºçš„è®¿é—®é€»è¾‘

**æ ¸å¿ƒç±»**: `DataFetcher`

**ä¸»è¦æ–¹æ³•**:

| æ–¹æ³•å | è¾“å…¥å‚æ•° | è¿”å›å€¼ | åŠŸèƒ½æè¿° |
| :--- | :--- | :--- | :--- |
| `get_volume_top_stocks(date, top_n)` | æ—¥æœŸ, æ’åæ•°é‡ | DataFrame | è·å–æˆäº¤é¢æ’åå‰Nçš„è‚¡ç¥¨ |
| `get_hot_top_stocks(date, top_n)` | æ—¥æœŸ, æ’åæ•°é‡ | DataFrame | è·å–çƒ­åº¦æ’åå‰Nçš„è‚¡ç¥¨ |
| `get_stock_daily_data(code, days)` | è‚¡ç¥¨ä»£ç , å¤©æ•° | DataFrame | è·å–æŒ‡å®šè‚¡ç¥¨çš„æ—¥çº¿è¡Œæƒ… |
| `get_stock_info(code)` | è‚¡ç¥¨ä»£ç  | Dict | è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯(åç§°ã€è¡Œä¸šç­‰) |

**å®ç°è¦ç‚¹**:
- ä½¿ç”¨ `pywencai.get()` è·å–æˆäº¤é¢å’Œçƒ­åº¦æ•°æ®
- ä½¿ç”¨ `akshare.stock_zh_a_hist()` è·å–æ—¥çº¿è¡Œæƒ…
- å®ç°æ•°æ®ç¼“å­˜æœºåˆ¶ï¼Œé¿å…é‡å¤è¯·æ±‚
- å¼‚å¸¸å¤„ç†ï¼šç½‘ç»œè¶…æ—¶ã€æ•°æ®ç¼ºå¤±ç­‰

**ä¼ªä»£ç ç¤ºä¾‹**:
```python
import pywencai
import akshare as ak
import pandas as pd

class DataFetcher:
    def get_volume_top_stocks(self, date, top_n):
        """è·å–æˆäº¤é¢æ’åå‰Nçš„è‚¡ç¥¨"""
        query = f'{date}æˆäº¤é¢å‰{top_n}'
        df = pywencai.get(query=query)
        # æ•°æ®æ¸…æ´—å’Œæ ‡å‡†åŒ–
        return df
    
    def get_hot_top_stocks(self, date, top_n):
        """è·å–çƒ­åº¦æ’åå‰Nçš„è‚¡ç¥¨"""
        query = f'{date}ä¸ªè‚¡çƒ­åº¦å‰{top_n}'
        df = pywencai.get(query=query)
        return df
    
    def get_stock_daily_data(self, code, days):
        """è·å–è‚¡ç¥¨æ—¥çº¿æ•°æ®"""
        df = ak.stock_zh_a_hist(symbol=code, period="daily", adjust="qfq")
        return df.tail(days)
```

---

#### 2.2.3 è‚¡ç¥¨ç­›é€‰æ¨¡å— (`modules/stock_filter.py`)

**èŒè´£**: å®ç°è‚¡ç¥¨ç­›é€‰çš„æ ¸å¿ƒç®—æ³•

**æ ¸å¿ƒç±»**: `StockFilter`

**ä¸»è¦æ–¹æ³•**:

| æ–¹æ³•å | è¾“å…¥å‚æ•° | è¿”å›å€¼ | åŠŸèƒ½æè¿° |
| :--- | :--- | :--- | :--- |
| `find_common_stocks(volume_df, hot_df)` | æˆäº¤é¢DF, çƒ­åº¦DF | Set | æ‰¾å‡ºä¸¤ä¸ªè‚¡æ± çš„äº¤é›† |
| `min_max_normalize(data)` | æ•°æ®åºåˆ— | Array | Min-Maxæ ‡å‡†åŒ– |
| `calculate_comprehensive_score(stocks)` | è‚¡ç¥¨åˆ—è¡¨ | DataFrame | è®¡ç®—ç»¼åˆè¯„åˆ† |
| `apply_filters(stocks)` | è‚¡ç¥¨åˆ—è¡¨ | DataFrame | åº”ç”¨è¿‡æ»¤è§„åˆ™ |

**æ ¸å¿ƒç®—æ³•**:

**1. ç»¼åˆè¯„åˆ†ç®—æ³•**
```
æ ‡å‡†åŒ–æˆäº¤é¢ = (æˆäº¤é¢ - min) / (max - min)
æ ‡å‡†åŒ–çƒ­åº¦ = (çƒ­åº¦ - min) / (max - min)
ç»¼åˆè¯„åˆ† = WEIGHT_VOLUME Ã— æ ‡å‡†åŒ–æˆäº¤é¢ + WEIGHT_HOT Ã— æ ‡å‡†åŒ–çƒ­åº¦
```

**2. è¿‡æ»¤è§„åˆ™**
- æ’é™¤ STã€*ST è‚¡ç¥¨ï¼ˆè‚¡ç¥¨åç§°åŒ…å«"ST"ï¼‰
- æ’é™¤ä¸Šå¸‚ä¸è¶³ N å¤©çš„æ¬¡æ–°è‚¡
- æ’é™¤ N å¤©å†…æ¶¨å¹…è¶…è¿‡é˜ˆå€¼çš„è‚¡ç¥¨

**ä¼ªä»£ç ç¤ºä¾‹**:
```python
class StockFilter:
    def calculate_comprehensive_score(self, volume_df, hot_df):
        """è®¡ç®—ç»¼åˆè¯„åˆ†"""
        # æ‰¾äº¤é›†
        common_codes = set(volume_df['è‚¡ç¥¨ä»£ç ']) & set(hot_df['è‚¡ç¥¨ä»£ç '])
        
        # æ ‡å‡†åŒ–
        volume_norm = self.min_max_normalize(volume_df['æˆäº¤é¢'])
        hot_norm = self.min_max_normalize(hot_df['çƒ­åº¦'])
        
        # åŠ æƒè®¡ç®—
        score = WEIGHT_VOLUME * volume_norm + WEIGHT_HOT * hot_norm
        
        # æ’åºå¹¶å–å‰Nå
        return df.nlargest(FINAL_TOP_N, 'score')
    
    def apply_filters(self, stocks_df):
        """åº”ç”¨è¿‡æ»¤è§„åˆ™"""
        # æ’é™¤STè‚¡
        if EXCLUDE_ST:
            stocks_df = stocks_df[~stocks_df['è‚¡ç¥¨åç§°'].str.contains('ST')]
        
        # æ’é™¤æ¬¡æ–°è‚¡
        # ... å…¶ä»–è¿‡æ»¤é€»è¾‘
        
        return stocks_df
```

---

#### 2.2.4 åŠ¨é‡è®¡ç®—æ¨¡å— (`modules/momentum_calculator.py`)

**èŒè´£**: è®¡ç®—è‚¡ç¥¨çš„åŠ¨é‡å¾—åˆ†

**æ ¸å¿ƒç±»**: `MomentumCalculator`

**ä¸»è¦æ–¹æ³•**:

| æ–¹æ³•å | è¾“å…¥å‚æ•° | è¿”å›å€¼ | åŠŸèƒ½æè¿° |
| :--- | :--- | :--- | :--- |
| `calculate_momentum(price_series)` | ä»·æ ¼åºåˆ— | Float | è®¡ç®—å•åªè‚¡ç¥¨çš„åŠ¨é‡åˆ† |
| `batch_calculate(stocks)` | è‚¡ç¥¨åˆ—è¡¨ | DataFrame | æ‰¹é‡è®¡ç®—åŠ¨é‡åˆ† |

**æ ¸å¿ƒç®—æ³•**: çº¿æ€§å›å½’åŠ¨é‡

```
1. è·å–è¿‡å» N å¤©çš„æ”¶ç›˜ä»·åºåˆ—
2. è®¡ç®—ç›¸å¯¹ä»·æ ¼: relative_price = price / price[0]
3. å¯¹ç›¸å¯¹ä»·æ ¼è¿›è¡Œçº¿æ€§å›å½’
4. åŠ¨é‡åˆ† = æ–œç‡ Ã— RÂ² Ã— 10000
```

**æ•°å­¦åŸç†**:
- **æ–œç‡ (slope)**: è¡¡é‡ä»·æ ¼ä¸Šæ¶¨çš„é€Ÿåº¦
- **RÂ² (å†³å®šç³»æ•°)**: è¡¡é‡è¶‹åŠ¿çš„ç¨³å®šæ€§ (0-1ä¹‹é—´ï¼Œè¶Šæ¥è¿‘1è¶Šç¨³å®š)
- **ä¹˜ä»¥10000**: æ”¾å¤§æ•°å€¼ï¼Œä¾¿äºæ¯”è¾ƒ

**ä¼ªä»£ç ç¤ºä¾‹**:
```python
from sklearn.linear_model import LinearRegression
import numpy as np

class MomentumCalculator:
    def calculate_momentum(self, price_series):
        """è®¡ç®—åŠ¨é‡å¾—åˆ†"""
        # è®¡ç®—ç›¸å¯¹ä»·æ ¼
        relative_prices = price_series / price_series.iloc[0]
        
        # å‡†å¤‡å›å½’æ•°æ®
        x = np.arange(len(relative_prices)).reshape(-1, 1)
        y = relative_prices.values
        
        # çº¿æ€§å›å½’
        lr = LinearRegression()
        lr.fit(x, y)
        
        # è®¡ç®—åŠ¨é‡åˆ†
        slope = lr.coef_[0]
        r_squared = lr.score(x, y)
        momentum_score = 10000 * slope * r_squared
        
        return momentum_score
```

---

#### 2.2.5 æŠ¥å‘Šç”Ÿæˆæ¨¡å— (`modules/report_generator.py`)

**èŒè´£**: ç”Ÿæˆå¯è§†åŒ– HTML æŠ¥å‘Š

**æ ¸å¿ƒç±»**: `ReportGenerator`

**ä¸»è¦æ–¹æ³•**:

| æ–¹æ³•å | è¾“å…¥å‚æ•° | è¿”å›å€¼ | åŠŸèƒ½æè¿° |
| :--- | :--- | :--- | :--- |
| `generate_kline_chart(stock_data)` | è‚¡ç¥¨æ•°æ® | Chartå¯¹è±¡ | ç”ŸæˆKçº¿å›¾ |
| `generate_report(stocks)` | è‚¡ç¥¨åˆ—è¡¨ | HTMLæ–‡ä»¶è·¯å¾„ | ç”Ÿæˆå®Œæ•´æŠ¥å‘Š |

**Kçº¿å›¾é…ç½®**:
- æ˜¾ç¤ºæœ€è¿‘ 60 ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®
- åŒ…å« MA5ã€MA10ã€MA20 å‡çº¿
- æˆäº¤é‡æŸ±çŠ¶å›¾
- äº¤äº’å¼ç¼©æ”¾ã€æ•°æ®æç¤º

**é¡µé¢å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è‚¡ç¥¨çŸ­çº¿å¤ç›˜æŠ¥å‘Š                   â”‚
â”‚        ç”Ÿæˆæ—¥æœŸ: 2025-10-14                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ’å1: è‚¡ç¥¨ä»£ç  - è‚¡ç¥¨åç§°                   â”‚
â”‚ åŠ¨é‡å¾—åˆ†: 85.6  |  æ‰€å±è¡Œä¸š: åŠå¯¼ä½“          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚         Kçº¿å›¾ + å‡çº¿ + æˆäº¤é‡          â”‚   â”‚
â”‚ â”‚                                      â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ’å2: ...                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼ªä»£ç ç¤ºä¾‹**:
```python
from pyecharts import options as opts
from pyecharts.charts import Kline, Line, Bar, Grid
from jinja2 import Environment, FileSystemLoader

class ReportGenerator:
    def generate_kline_chart(self, stock_data):
        """ç”ŸæˆKçº¿å›¾"""
        kline = (
            Kline()
            .add_xaxis(stock_data['æ—¥æœŸ'].tolist())
            .add_yaxis("Kçº¿", stock_data[['å¼€ç›˜', 'æ”¶ç›˜', 'æœ€ä½', 'æœ€é«˜']].values.tolist())
            .set_global_opts(
                title_opts=opts.TitleOpts(title=f"{stock_data['åç§°']}"),
                xaxis_opts=opts.AxisOpts(is_scale=True),
                yaxis_opts=opts.AxisOpts(is_scale=True),
            )
        )
        
        # æ·»åŠ å‡çº¿
        for period in MA_PERIODS:
            ma_line = Line().add_xaxis(...).add_yaxis(f"MA{period}", ...)
            kline.overlap(ma_line)
        
        return kline
    
    def generate_report(self, stocks_data):
        """ç”ŸæˆHTMLæŠ¥å‘Š"""
        # ä¸ºæ¯åªè‚¡ç¥¨ç”Ÿæˆå›¾è¡¨
        charts = []
        for stock in stocks_data:
            chart = self.generate_kline_chart(stock)
            charts.append(chart.render_embed())
        
        # ä½¿ç”¨Jinja2æ¸²æŸ“æ¨¡æ¿
        env = Environment(loader=FileSystemLoader(TEMPLATE_DIR))
        template = env.get_template('report_template.html')
        
        html_content = template.render(
            date=datetime.now().strftime('%Y-%m-%d'),
            stocks=stocks_data,
            charts=charts
        )
        
        # ä¿å­˜æ–‡ä»¶
        output_path = f"{OUTPUT_DIR}/report_{datetime.now().strftime('%Y%m%d')}.html"
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(html_content)
        
        return output_path
```

---

## 3. ä¸»ç¨‹åºæµç¨‹ (`main.py`)

### 3.1 æ‰§è¡Œæµç¨‹å›¾

```
å¼€å§‹
  â”‚
  â”œâ”€â†’ è¯»å–é…ç½®å‚æ•° (config.py)
  â”‚
  â”œâ”€â†’ åˆå§‹åŒ–æ•°æ®è·å–å™¨ (DataFetcher)
  â”‚
  â”œâ”€â†’ è·å–æˆäº¤é¢Top100 + çƒ­åº¦Top100
  â”‚
  â”œâ”€â†’ è‚¡ç¥¨ç­›é€‰ (StockFilter)
  â”‚    â”œâ”€ æ‰¾äº¤é›†
  â”‚    â”œâ”€ è®¡ç®—ç»¼åˆè¯„åˆ†
  â”‚    â”œâ”€ åº”ç”¨è¿‡æ»¤è§„åˆ™
  â”‚    â””â”€ å–å‰30å
  â”‚
  â”œâ”€â†’ åŠ¨é‡è®¡ç®— (MomentumCalculator)
  â”‚    â”œâ”€ è·å–æ¯åªè‚¡ç¥¨çš„å†å²è¡Œæƒ…
  â”‚    â”œâ”€ è®¡ç®—åŠ¨é‡å¾—åˆ†
  â”‚    â””â”€ æ’åºå–å‰10å
  â”‚
  â”œâ”€â†’ æŠ¥å‘Šç”Ÿæˆ (ReportGenerator)
  â”‚    â”œâ”€ ç”ŸæˆKçº¿å›¾
  â”‚    â”œâ”€ æ¸²æŸ“HTMLæ¨¡æ¿
  â”‚    â””â”€ ä¿å­˜æ–‡ä»¶
  â”‚
  â””â”€â†’ è¾“å‡ºæŠ¥å‘Šè·¯å¾„ï¼Œå®Œæˆ
```

### 3.2 ä¸»ç¨‹åºä¼ªä»£ç 

```python
from modules.data_fetcher import DataFetcher
from modules.stock_filter import StockFilter
from modules.momentum_calculator import MomentumCalculator
from modules.report_generator import ReportGenerator
from config import *
from datetime import datetime

def main():
    print("=" * 50)
    print("è‚¡ç¥¨çŸ­çº¿å¤ç›˜åŠ©æ‰‹ V1.0")
    print("=" * 50)
    
    # 1. åˆå§‹åŒ–
    fetcher = DataFetcher()
    filter = StockFilter()
    calculator = MomentumCalculator()
    generator = ReportGenerator()
    
    today = datetime.now().strftime('%Y-%m-%d')
    
    # 2. æ•°æ®è·å–
    print(f"\n[1/4] æ­£åœ¨è·å– {today} çš„å¸‚åœºæ•°æ®...")
    volume_df = fetcher.get_volume_top_stocks(today, VOLUME_TOP_N)
    hot_df = fetcher.get_hot_top_stocks(today, HOT_TOP_N)
    print(f"âœ“ æˆäº¤é¢Top{VOLUME_TOP_N}: {len(volume_df)} åª")
    print(f"âœ“ çƒ­åº¦Top{HOT_TOP_N}: {len(hot_df)} åª")
    
    # 3. ç»¼åˆç­›é€‰
    print(f"\n[2/4] æ­£åœ¨è¿›è¡Œç»¼åˆè¯„åˆ†ç­›é€‰...")
    candidates = filter.calculate_comprehensive_score(volume_df, hot_df)
    candidates = filter.apply_filters(candidates)
    print(f"âœ“ åˆé€‰æ± : {len(candidates)} åª")
    
    # 4. åŠ¨é‡è®¡ç®—
    print(f"\n[3/4] æ­£åœ¨è®¡ç®—åŠ¨é‡å¾—åˆ†...")
    final_stocks = calculator.batch_calculate(candidates)
    final_stocks = final_stocks.nlargest(MOMENTUM_TOP_N, 'momentum_score')
    print(f"âœ“ æœ€ç»ˆç­›é€‰: {len(final_stocks)} åª")
    
    # 5. ç”ŸæˆæŠ¥å‘Š
    print(f"\n[4/4] æ­£åœ¨ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š...")
    report_path = generator.generate_report(final_stocks)
    print(f"âœ“ æŠ¥å‘Šå·²ç”Ÿæˆ: {report_path}")
    
    print("\n" + "=" * 50)
    print("å¤ç›˜å®Œæˆï¼")
    print("=" * 50)

if __name__ == "__main__":
    main()
```

---

## 4. HTML æ¨¡æ¿è®¾è®¡ (`templates/report_template.html`)

### 4.1 æ¨¡æ¿ç»“æ„

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨çŸ­çº¿å¤ç›˜æŠ¥å‘Š - {{ date }}</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header>
        <h1>ğŸ“ˆ è‚¡ç¥¨çŸ­çº¿å¤ç›˜æŠ¥å‘Š</h1>
        <p class="date">ç”Ÿæˆæ—¥æœŸ: {{ date }}</p>
    </header>
    
    <!-- è‚¡ç¥¨åˆ—è¡¨ -->
    <main>
        {% for stock in stocks %}
        <div class="stock-card">
            <div class="stock-header">
                <h2>æ’å {{ loop.index }}: {{ stock.code }} - {{ stock.name }}</h2>
                <div class="metrics">
                    <span class="momentum">åŠ¨é‡å¾—åˆ†: {{ stock.momentum_score | round(2) }}</span>
                    <span class="industry">è¡Œä¸š: {{ stock.industry }}</span>
                </div>
            </div>
            <div class="chart-container">
                {{ charts[loop.index0] | safe }}
            </div>
        </div>
        {% endfor %}
    </main>
    
    <!-- é¡µé¢åº•éƒ¨ -->
    <footer>
        <p>âš ï¸ æœ¬æŠ¥å‘Šä»…ä¾›å¤ç›˜å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚å¸‚åœºæœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚</p>
    </footer>
</body>
</html>
```

### 4.2 æ ·å¼è®¾è®¡è¦ç‚¹ (`static/style.css`)

- ä½¿ç”¨ç°ä»£åŒ–çš„å¡ç‰‡å¼å¸ƒå±€
- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯æŸ¥çœ‹
- æ¸…æ™°çš„è§†è§‰å±‚æ¬¡ï¼šæ ‡é¢˜ > æŒ‡æ ‡ > å›¾è¡¨
- é…è‰²æ–¹æ¡ˆï¼šä¸“ä¸šã€ç®€æ´ã€æŠ¤çœ¼

---

## 5. æ•°æ®æµè®¾è®¡

### 5.1 æ•°æ®æµè½¬å›¾

```
å¤–éƒ¨æ•°æ®æº
    â”‚
    â”œâ”€â†’ pywencai API
    â”‚      â””â”€â†’ æˆäº¤é¢æ’åã€çƒ­åº¦æ’å (JSON)
    â”‚
    â””â”€â†’ akshare API
           â””â”€â†’ æ—¥çº¿è¡Œæƒ…ã€è‚¡ç¥¨ä¿¡æ¯ (DataFrame)
                  â”‚
                  â–¼
            DataFetcher (æ•°æ®è·å–)
                  â”‚
                  â”œâ”€â†’ åŸå§‹æ•°æ® (DataFrame)
                  â”‚
                  â–¼
            StockFilter (æ•°æ®ç­›é€‰)
                  â”‚
                  â”œâ”€â†’ å€™é€‰è‚¡æ±  (DataFrame)
                  â”‚
                  â–¼
            MomentumCalculator (åŠ¨é‡è®¡ç®—)
                  â”‚
                  â”œâ”€â†’ æœ€ç»ˆè‚¡ç¥¨åˆ—è¡¨ + åŠ¨é‡åˆ† (DataFrame)
                  â”‚
                  â–¼
            ReportGenerator (æŠ¥å‘Šç”Ÿæˆ)
                  â”‚
                  â”œâ”€â†’ HTML å­—ç¬¦ä¸²
                  â”‚
                  â–¼
            è¾“å‡ºæ–‡ä»¶ (report_YYYYMMDD.html)
```

---

## 6. å¼‚å¸¸å¤„ç†ä¸å®¹é”™

### 6.1 å¼‚å¸¸åœºæ™¯

| å¼‚å¸¸åœºæ™¯ | å¤„ç†ç­–ç•¥ |
| :--- | :--- |
| ç½‘ç»œè¯·æ±‚å¤±è´¥ | é‡è¯•3æ¬¡ï¼Œå¤±è´¥åæç¤ºç”¨æˆ·æ£€æŸ¥ç½‘ç»œ |
| æ•°æ®æºè¿”å›ç©ºæ•°æ® | è®°å½•æ—¥å¿—ï¼Œè·³è¿‡è¯¥è‚¡ç¥¨ï¼Œç»§ç»­å¤„ç†å…¶ä»– |
| è‚¡ç¥¨ä»£ç æ— æ•ˆ | è¿‡æ»¤æ‰æ— æ•ˆä»£ç ï¼Œè®°å½•è­¦å‘Š |
| æ¨¡æ¿æ–‡ä»¶ç¼ºå¤± | æŠ›å‡ºå¼‚å¸¸ï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥é¡¹ç›®å®Œæ•´æ€§ |
| è¾“å‡ºç›®å½•ä¸å­˜åœ¨ | è‡ªåŠ¨åˆ›å»ºç›®å½• |

### 6.2 æ—¥å¿—è®¾è®¡

ä½¿ç”¨ Python æ ‡å‡†åº“ `logging` è®°å½•å…³é”®ä¿¡æ¯ï¼š

```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(message)s',
    handlers=[
        logging.FileHandler('stockguru.log'),
        logging.StreamHandler()
    ]
)
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 ä¼˜åŒ–ç­–ç•¥

| ä¼˜åŒ–ç‚¹ | ç­–ç•¥ | é¢„æœŸæ•ˆæœ |
| :--- | :--- | :--- |
| æ•°æ®è·å– | ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œé¿å…é‡å¤è¯·æ±‚ | å‡å°‘50%ç½‘ç»œè¯·æ±‚ |
| å¹¶å‘å¤„ç† | ä½¿ç”¨çº¿ç¨‹æ± å¹¶å‘è·å–å¤šåªè‚¡ç¥¨æ•°æ® | æé€Ÿ3-5å€ |
| æ•°æ®è®¡ç®— | ä½¿ç”¨ numpy å‘é‡åŒ–è®¡ç®— | æé€Ÿ10å€ä»¥ä¸Š |
| å›¾è¡¨æ¸²æŸ“ | å»¶è¿ŸåŠ è½½ï¼ŒæŒ‰éœ€æ¸²æŸ“ | å‡å°‘å†…å­˜å ç”¨ |

### 7.2 æ€§èƒ½æŒ‡æ ‡

- æ•°æ®è·å–: â‰¤ 30ç§’
- æ•°æ®å¤„ç†: â‰¤ 10ç§’
- æŠ¥å‘Šç”Ÿæˆ: â‰¤ 20ç§’
- **æ€»è€—æ—¶: â‰¤ 60ç§’**

---

## 8. æµ‹è¯•è®¡åˆ’

### 8.1 å•å…ƒæµ‹è¯•

| æ¨¡å— | æµ‹è¯•ç”¨ä¾‹ |
| :--- | :--- |
| `data_fetcher.py` | æµ‹è¯•æ•°æ®è·å–çš„æ­£ç¡®æ€§å’Œå¼‚å¸¸å¤„ç† |
| `stock_filter.py` | æµ‹è¯•ç­›é€‰ç®—æ³•çš„å‡†ç¡®æ€§ |
| `momentum_calculator.py` | æµ‹è¯•åŠ¨é‡è®¡ç®—çš„æ•°å­¦æ­£ç¡®æ€§ |
| `report_generator.py` | æµ‹è¯•HTMLç”Ÿæˆçš„å®Œæ•´æ€§ |

### 8.2 é›†æˆæµ‹è¯•

- ç«¯åˆ°ç«¯æµ‹è¯•ï¼šä»æ•°æ®è·å–åˆ°æŠ¥å‘Šç”Ÿæˆçš„å®Œæ•´æµç¨‹
- è¾¹ç•Œæµ‹è¯•ï¼šç©ºæ•°æ®ã€æç«¯æ•°æ®çš„å¤„ç†
- æ€§èƒ½æµ‹è¯•ï¼šå¤§æ•°æ®é‡ä¸‹çš„æ‰§è¡Œæ—¶é—´

---

## 9. éƒ¨ç½²ä¸ä½¿ç”¨

### 9.1 å®‰è£…æ­¥éª¤

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository_url>
cd StockGuru

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 4. è¿è¡Œç¨‹åº
python main.py
```

### 9.2 ä½¿ç”¨è¯´æ˜

1. è¿è¡Œ `python main.py`
2. ç­‰å¾…ç¨‹åºæ‰§è¡Œå®Œæˆï¼ˆçº¦1-2åˆ†é’Ÿï¼‰
3. åœ¨ `output/` ç›®å½•ä¸‹æ‰¾åˆ°ç”Ÿæˆçš„ HTML æ–‡ä»¶
4. åŒå‡»æ‰“å¼€ï¼Œå³å¯åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹å¤ç›˜æŠ¥å‘Š

### 9.3 å‚æ•°è°ƒæ•´

ç¼–è¾‘ `config.py` æ–‡ä»¶ï¼Œä¿®æ”¹ç›¸å…³å‚æ•°åé‡æ–°è¿è¡Œå³å¯ã€‚

---

## 10. æœªæ¥æ‰©å±•æ–¹å‘

### 10.1 V2.0 åŠŸèƒ½è§„åˆ’

- **å›æµ‹åŠŸèƒ½**: éªŒè¯ç­–ç•¥çš„å†å²è¡¨ç°
- **å¤šç­–ç•¥æ”¯æŒ**: å…è®¸ç”¨æˆ·é€‰æ‹©ä¸åŒçš„ç­›é€‰ç­–ç•¥
- **å®æ—¶ç›‘æ§**: ç›˜ä¸­å®æ—¶æ›´æ–°å¼ºåŠ¿è‚¡åˆ—è¡¨
- **æ¶ˆæ¯æ¨é€**: é€šè¿‡é‚®ä»¶æˆ–å¾®ä¿¡æ¨é€æŠ¥å‘Š

### 10.2 æŠ€æœ¯æ¼”è¿›

- å¼•å…¥æ•°æ®åº“å­˜å‚¨å†å²æ•°æ®
- å¼€å‘ Web ç‰ˆæœ¬ï¼Œæ”¯æŒåœ¨çº¿è®¿é—®
- é›†æˆæ›´å¤šæ•°æ®æºå’ŒæŠ€æœ¯æŒ‡æ ‡

---

## é™„å½•

### A. ä¾èµ–æ¸…å• (`requirements.txt`)

```
pandas>=1.3.0
numpy>=1.20.0
scikit-learn>=0.24.0
pywencai
akshare
pyecharts>=2.0.0
jinja2>=3.0.0
python-dateutil>=2.8.0
```

### B. å‚è€ƒèµ„æ–™

- Pyecharts å®˜æ–¹æ–‡æ¡£: https://pyecharts.org/
- Akshare å®˜æ–¹æ–‡æ¡£: https://akshare.akfamily.xyz/
- Jinja2 å®˜æ–¹æ–‡æ¡£: https://jinja.palletsprojects.com/

---

**æ–‡æ¡£ç»“æŸ**
