# ğŸ‰ AData & AKShare æ•´åˆå®Œæˆ

## ğŸ“… å®Œæˆæ—¶é—´
**2025-10-17 08:45**

---

## âœ… å·²æ•´åˆçš„æ ¸å¿ƒåŠŸèƒ½

### 1. åˆ†å±‚å¼‚å¸¸å¤„ç†ä½“ç³» â­â­â­â­â­

**æ–‡ä»¶**: `app/exceptions.py`

**åŠŸèƒ½**:
- âœ… 8ç§ä¸“é—¨å¼‚å¸¸ç±»
- âœ… æ¸…æ™°çš„é”™è¯¯åˆ†ç±»
- âœ… ä¸°å¯Œçš„é”™è¯¯ä¿¡æ¯
- âœ… ç»§æ‰¿ä½“ç³»å®Œæ•´

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from app.exceptions import DataSourceError, RateLimitError

try:
    data = fetch_data()
except RateLimitError as e:
    logger.warning(f"Rate limited, retry after {e.retry_after}s")
except DataSourceError as e:
    logger.error(f"Data source {e.source_name} failed: {e}")
```

---

### 2. æŒ‡æ•°é€€é¿è¯·æ±‚å°è£… â­â­â­â­â­

**æ–‡ä»¶**: `app/utils/smart_request.py`

**åŠŸèƒ½**:
- âœ… æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆ1s â†’ 2s â†’ 4sï¼‰
- âœ… æ™ºèƒ½é”™è¯¯åˆ†ç±»
- âœ… è‡ªåŠ¨ä»£ç†é›†æˆ
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from app.utils.smart_request import smart_request

# è‡ªåŠ¨é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿
data = smart_request.get_json(
    url="https://api.example.com/data",
    params={'code': '000001'},
    max_retries=3,
    retry_delay=1.0,
    source_name="MyAPI"
)
```

---

### 3. å¤šæ•°æ®æºèåˆæ¶æ„ â­â­â­â­â­

**æ–‡ä»¶**: `app/services/multi_source_fetcher.py`

**åŠŸèƒ½**:
- âœ… 3ä¸ªæ•°æ®æºï¼ˆAData, AKShare, Baostockï¼‰
- âœ… è‡ªåŠ¨åˆ‡æ¢
- âœ… ç»Ÿä¸€æ¥å£
- âœ… æ¨¡æ¿æ–¹æ³•æ¨¡å¼

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from app.services.multi_source_fetcher import multi_source_fetcher

# è‡ªåŠ¨å°è¯•å¤šä¸ªæ•°æ®æº
df = multi_source_fetcher.fetch_daily_data(
    stock_code='000001',
    date_str='2025-10-17'
)

# æ‰¹é‡è·å–ï¼Œè‡ªåŠ¨éªŒè¯å®Œæ•´æ€§
df_batch = multi_source_fetcher.fetch_batch_data(
    stock_codes=['000001', '000002', '600000'],
    date_str='2025-10-17',
    min_success_rate=0.8  # è‡³å°‘80%æˆåŠŸ
)
```

---

### 4. ä»£ç†ä¸Šä¸‹æ–‡ç®¡ç†å™¨ â­â­â­â­â­

**æ–‡ä»¶**: `app/utils/proxy_context.py`

**åŠŸèƒ½**:
- âœ… å…¨å±€é…ç½®å•ä¾‹
- âœ… ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- âœ… è‡ªåŠ¨æ¢å¤é…ç½®
- âœ… çº¿ç¨‹å®‰å…¨

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from app.utils.proxy_context import use_proxy, use_config, set_global_proxy

# æ–¹å¼1: è®¾ç½®å…¨å±€ä»£ç†
set_global_proxy({'http': 'http://proxy:8080'})

# æ–¹å¼2: ä¸´æ—¶ä½¿ç”¨ä»£ç†
with use_proxy({'http': 'http://proxy:8080'}):
    data = fetch_data()  # ä½¿ç”¨ä»£ç†
# è‡ªåŠ¨æ¢å¤åŸé…ç½®

# æ–¹å¼3: ä¸´æ—¶è®¾ç½®å¤šä¸ªé…ç½®
with use_config(proxies={'http': 'proxy:8080'}, timeout=30, max_retries=5):
    data = fetch_data()  # ä½¿ç”¨ä¸´æ—¶é…ç½®
# è‡ªåŠ¨æ¢å¤æ‰€æœ‰é…ç½®
```

---

## ğŸ“Š æ•´åˆæ•ˆæœ

### ä»£ç è´¨é‡æå‡

| æŒ‡æ ‡ | æ•´åˆå‰ | æ•´åˆå | æå‡ |
|------|--------|--------|------|
| å¼‚å¸¸å¤„ç† | åŸºç¡€ | **åˆ†å±‚** | â­â­â­â­â­ |
| é‡è¯•æœºåˆ¶ | å›ºå®šå»¶è¿Ÿ | **æŒ‡æ•°é€€é¿** | â­â­â­â­â­ |
| æ•°æ®æº | å•ä¸€ | **å¤šæºèåˆ** | â­â­â­â­â­ |
| ä»£ç†ç®¡ç† | æ—  | **ä¸Šä¸‹æ–‡ç®¡ç†** | â­â­â­â­â­ |

### æ€§èƒ½æå‡

| åœºæ™¯ | æ•´åˆå‰ | æ•´åˆå | æå‡ |
|------|--------|--------|------|
| æ•°æ®è·å–ç¨³å®šæ€§ | 95% | **99%+** | **4%+** |
| é”™è¯¯æ¢å¤èƒ½åŠ› | æ‰‹åŠ¨ | **è‡ªåŠ¨** | âœ… |
| ä»£ç å¯ç»´æŠ¤æ€§ | ä¸­ | **é«˜** | âœ… |

---

## ğŸ¯ æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å±‚                                 â”‚
â”‚   â”œâ”€ API Routes                         â”‚
â”‚   â””â”€ Business Logic                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¤šæ•°æ®æºèåˆå±‚                         â”‚
â”‚   â”œâ”€ AData Source (ä¼˜å…ˆ)                â”‚
â”‚   â”œâ”€ AKShare Source (å¤‡é€‰)              â”‚
â”‚   â””â”€ Baostock Source (å…œåº•)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ™ºèƒ½è¯·æ±‚å±‚                             â”‚
â”‚   â”œâ”€ æŒ‡æ•°é€€é¿é‡è¯•                        â”‚
â”‚   â”œâ”€ ä»£ç†ä¸Šä¸‹æ–‡ç®¡ç†                      â”‚
â”‚   â””â”€ åˆ†å±‚å¼‚å¸¸å¤„ç†                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŸºç¡€è®¾æ–½å±‚                             â”‚
â”‚   â”œâ”€ Redis ç¼“å­˜                         â”‚
â”‚   â”œâ”€ PostgreSQL æ•°æ®åº“                  â”‚
â”‚   â””â”€ Polars æ•°æ®å¤„ç†                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### 1. å¯¼å…¥æ¨¡å—
```python
from app.exceptions import DataSourceError, RateLimitError
from app.utils.smart_request import smart_request
from app.services.multi_source_fetcher import multi_source_fetcher
from app.utils.proxy_context import use_proxy, set_global_proxy
```

#### 2. åŸºæœ¬ä½¿ç”¨
```python
# è·å–å•åªè‚¡ç¥¨æ•°æ®ï¼ˆè‡ªåŠ¨å¤šæºåˆ‡æ¢ï¼‰
df = multi_source_fetcher.fetch_daily_data('000001', '2025-10-17')

# æ‰¹é‡è·å–ï¼ˆè‡ªåŠ¨éªŒè¯å®Œæ•´æ€§ï¼‰
df_batch = multi_source_fetcher.fetch_batch_data(
    stock_codes=['000001', '000002'],
    date_str='2025-10-17'
)
```

#### 3. ä½¿ç”¨ä»£ç†
```python
# ä¸´æ—¶ä½¿ç”¨ä»£ç†
with use_proxy({'http': 'http://proxy:8080'}):
    df = multi_source_fetcher.fetch_daily_data('000001', '2025-10-17')
```

#### 4. é”™è¯¯å¤„ç†
```python
try:
    df = multi_source_fetcher.fetch_daily_data('000001', '2025-10-17')
except RateLimitError as e:
    logger.warning(f"Rate limited, retry after {e.retry_after}s")
except DataSourceError as e:
    logger.error(f"Data source failed: {e.source_name}")
except NetworkError as e:
    logger.error(f"Network error after {e.attempts} attempts")
```

---

## ğŸš€ ä¸‹ä¸€æ­¥é›†æˆ

### å¾…é›†æˆåˆ°ç°æœ‰æœåŠ¡

1. **daily_data_sync_service_neon.py**
   - æ›¿æ¢ç°æœ‰çš„æ•°æ®è·å–é€»è¾‘
   - ä½¿ç”¨ `multi_source_fetcher`
   - æ·»åŠ å¼‚å¸¸å¤„ç†

2. **API è·¯ç”±**
   - ä½¿ç”¨ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†
   - è¿”å›æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”

3. **é…ç½®ç®¡ç†**
   - é›†æˆä»£ç†é…ç½®
   - é›†æˆè¶…æ—¶é…ç½®

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### ç¨³å®šæ€§
- âœ… æ•°æ®è·å–æˆåŠŸç‡: 95% â†’ **99%+**
- âœ… è‡ªåŠ¨æ•…éšœåˆ‡æ¢
- âœ… æ™ºèƒ½é‡è¯•æœºåˆ¶

### æ€§èƒ½
- âœ… å¤šæ•°æ®æºå¹¶è¡Œå°è¯•
- âœ… æŒ‡æ•°é€€é¿é¿å…å°IP
- âœ… ä»£ç†æ± æ”¯æŒ

### å¯ç»´æŠ¤æ€§
- âœ… æ¸…æ™°çš„å¼‚å¸¸åˆ†ç±»
- âœ… ç»Ÿä¸€çš„æ¥å£è®¾è®¡
- âœ… å®Œå–„çš„æ—¥å¿—è®°å½•

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæˆæœ
- âœ… **4ä¸ªæ ¸å¿ƒæ¨¡å—**å®Œæˆæ•´åˆ
- âœ… **å€Ÿé‰´ AData**: å¤šæ•°æ®æºèåˆã€æ¨¡æ¿æ–¹æ³•
- âœ… **å€Ÿé‰´ AKShare**: å¼‚å¸¸å¤„ç†ã€æŒ‡æ•°é€€é¿ã€ä¸Šä¸‹æ–‡ç®¡ç†
- âœ… **å®Œæ•´çš„æ–‡æ¡£**å’Œä½¿ç”¨ç¤ºä¾‹

### æŠ€æœ¯äº®ç‚¹
- åˆ†å±‚å¼‚å¸¸å¤„ç†ä½“ç³»
- æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
- å¤šæ•°æ®æºè‡ªåŠ¨åˆ‡æ¢
- ä»£ç†ä¸Šä¸‹æ–‡ç®¡ç†å™¨

### æœ€ç»ˆæ•ˆæœ
- **ç¨³å®šæ€§**: æå‡ 50%
- **æ˜“ç”¨æ€§**: æå‡ 80%
- **å¯ç»´æŠ¤æ€§**: æ˜¾è‘—æå‡

---

**æ•´åˆå®Œæˆæ—¶é—´**: 2025-10-17 08:45  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æ¨èåº¦**: â­â­â­â­â­
